<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Domina tu instrumento</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f0c1a;
      color: white;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #1a132a;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #5e4aff;
    }
    .section {
      background: #251e35;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .section h2 {
      margin-bottom: 15px;
      color: #5e4aff;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2c243a;
      color: white;
      font-size: 1rem;
    }
    button {
      background: linear-gradient(135deg, #5e4aff 0%, #3b2cff 100%);
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    #scoreContainer {
      height: 500px;
      margin: 15px 0;
      border: 1px dashed #555;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      overflow: hidden;
      position: relative;
    }
    #scoreContainer img,
    #scoreContainer embed {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain;
      border: none;
    }
    #currentMeasureIndicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(231, 76, 60, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      z-index: 1000;
    }
    .hint {
      font-size: 0.9rem;
      color: #aaa;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ Domina tu instrumento</h1>
    
    <div class="section">
      <h2>1. Prepara tu pr√°ctica</h2>
      <p class="hint">Sube tu audio, tu partitura y elige tu instrumento. ¬°La app har√° el resto!</p>
      
      <label>Audio (MP3 o MP4):</label>
      <input type="file" id="audioFile" accept="audio/mp3,audio/mpeg,video/mp4" />
      
      <label>Partitura (PDF, JPG o PNG):</label>
      <input type="file" id="scoreFile" accept=".pdf,.jpg,.jpeg,.png" />
      
      <label>Tu instrumento:</label>
      <select id="instrumentSelect">
        <option value="">Selecciona tu instrumento</option>
        <option value="bateria">Bater√≠a</option>
        <option value="guitarra">Guitarra</option>
        <option value="bajo">Bajo</option>
        <option value="piano">Piano/Teclado</option>
        <option value="voz">Voz</option>
        <option value="saxo">Saxo</option>
        <option value="trompeta">Trompeta</option>
        <option value="violin">Viol√≠n</option>
        <option value="flauta">Flauta</option>
        <option value="otro">Otro</option>
      </select>
      
      <audio id="audioPlayer" controls style="width: 100%; margin: 15px 0; background: #2c243a; padding: 10px; border-radius: 6px;"></audio>
      <div id="scoreContainer">Sube tu partitura para verla aqu√≠</div>
    </div>

    <div class="section">
      <h2>2. ¬°Practica!</h2>
      <p class="hint">La partitura se resaltar√° autom√°ticamente en tiempo real mientras suena el audio.</p>
      <button id="startPractice">‚ñ∂Ô∏è Empezar a practicar</button>
    </div>
  </div>

  <div id="currentMeasureIndicator" style="display: none;">
    Comp√°s: <span id="measureNumber">0</span>
  </div>

  <script>
    // Estado
    let currentAudioFile = null;
    let currentScoreFile = null;
    let currentInstrument = '';
    let currentOffset = 0;
    let bpm = 120;
    let measureDuration = 60 / bpm;
    let syncInterval = null;
    let overlayCanvas = null;

    // Elementos
    const audioFileInput = document.getElementById('audioFile');
    const scoreFileInput = document.getElementById('scoreFile');
    const instrumentSelect = document.getElementById('instrumentSelect');
    const startPracticeBtn = document.getElementById('startPractice');
    const audioPlayer = document.getElementById('audioPlayer');
    const scoreContainer = document.getElementById('scoreContainer');
    const measureNumberEl = document.getElementById('measureNumber');

    // Cargar audio
    audioFileInput.addEventListener('change', (e) => {
      currentAudioFile = e.target.files[0];
      if (currentAudioFile) {
        const url = URL.createObjectURL(currentAudioFile);
        audioPlayer.src = url;
      }
    });

    // Cargar partitura
    scoreFileInput.addEventListener('change', (e) => {
      currentScoreFile = e.target.files[0];
      if (currentScoreFile) {
        scoreContainer.innerHTML = '<p>Cargando partitura...</p>';
        if (currentScoreFile.type === 'application/pdf') {
          try {
            const url = URL.createObjectURL(currentScoreFile);
            const embed = document.createElement('embed');
            embed.src = url;
            embed.type = 'application/pdf';
            embed.id = 'scoreContent'; // ‚úÖ ID para referencia
            scoreContainer.innerHTML = '';
            scoreContainer.appendChild(embed);
          } catch (e) {
            scoreContainer.innerHTML = '<p style="color:#ff6b6b;">Error al cargar PDF.</p>';
          }
        } else if (currentScoreFile.type.startsWith('image/')) {
          const url = URL.createObjectURL(currentScoreFile);
          const img = document.createElement('img');
          img.src = url;
          img.id = 'scoreContent'; // ‚úÖ ID para referencia
          scoreContainer.innerHTML = '';
          scoreContainer.appendChild(img);
        } else {
          scoreContainer.innerHTML = '<p style="color:#ff6b6b;">Formato no soportado.</p>';
        }
      }
    });

    // Seleccionar instrumento
    instrumentSelect.addEventListener('change', () => {
      currentInstrument = instrumentSelect.value;
    });

    // ‚úÖ FUNCI√ìN CORREGIDA: Overlay anclado a la partitura real
    function createOverlay() {
      if (overlayCanvas) {
        if (overlayCanvas.parentNode) {
          overlayCanvas.parentNode.removeChild(overlayCanvas);
        }
        overlayCanvas = null;
      }

      // ‚úÖ Buscar la partitura real (img o embed)
      const content = document.getElementById('scoreContent');
      if (!content) return;

      // ‚úÖ Crear overlay dentro del contenedor, pero posicionado sobre la partitura
      overlayCanvas = document.createElement('canvas');
      overlayCanvas.style.position = 'absolute';
      overlayCanvas.style.pointerEvents = 'none';
      overlayCanvas.style.zIndex = '10';
      scoreContainer.appendChild(overlayCanvas);

      // ‚úÖ Ajustar tama√±o al de la partitura real
      const rect = content.getBoundingClientRect();
      const containerRect = scoreContainer.getBoundingClientRect();
      
      overlayCanvas.width = rect.width;
      overlayCanvas.height = rect.height;
      overlayCanvas.style.left = (rect.left - containerRect.left) + 'px';
      overlayCanvas.style.top = (rect.top - containerRect.top) + 'px';
    }

    // ‚úÖ FUNCI√ìN CORREGIDA: Resaltar sobre la partitura real
    function highlightMeasure(index) {
      if (!overlayCanvas) return;
      const ctx = overlayCanvas.getContext('2d');
      ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      
      const measuresPerLine = 4;
      const measureWidth = overlayCanvas.width / measuresPerLine;
      const lineHeight = overlayCanvas.height * 0.2;
      const line = Math.floor(index / measuresPerLine);
      const col = index % measuresPerLine;
      
      if (line * lineHeight < overlayCanvas.height) {
        ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
        ctx.fillRect(
          col * measureWidth,
          line * lineHeight,
          measureWidth,
          lineHeight
        );
      }
    }

    // Sincronizaci√≥n
    function startSync() {
      document.getElementById('currentMeasureIndicator').style.display = 'block';
      measureDuration = 60 / bpm;
      createOverlay(); // ‚úÖ Se llama despu√©s de cargar
      
      if (syncInterval) clearInterval(syncInterval);
      syncInterval = setInterval(() => {
        const audioTime = audioPlayer.currentTime;
        const syncTime = audioTime + currentOffset;
        const currentMeasure = syncTime >= 0 ? Math.floor(syncTime / measureDuration) : -1;
        measureNumberEl.textContent = currentMeasure + 1;
        highlightMeasure(currentMeasure);
      }, 100);
    }

    // Empezar
    startPracticeBtn.addEventListener('click', () => {
      if (!currentAudioFile || !currentScoreFile || !currentInstrument) {
        alert('Por favor, sube el audio, la partitura y elige tu instrumento.');
        return;
      }
      startSync();
      alert('¬°Pr√°ctica iniciada! La partitura se resaltar√° autom√°ticamente.');
    });
  </script>
</body>
</html>
