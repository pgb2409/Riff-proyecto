<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Domina tu instrumento</title>
  <style>
    /* ... (todo el CSS igual que antes) ... */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0f0c1a;
      color: #fff;
      line-height: 1.6;
    }

    .screen {
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Pantalla de bienvenida */
    #welcomeScreen {
      background: linear-gradient(135deg, #0f0c1a 0%, #1a132a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 20px;
    }

    .header {
      width: 100%;
      max-width: 800px;
      margin-bottom: 40px;
      position: relative;
    }

    .logo {
      background: rgba(255, 255, 255, 0.1);
      width: 80px;
      height: 80px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .icon {
      font-size: 32px;
      color: #fff;
    }

    .waveform {
      width: 100%;
      height: 100px;
      background: linear-gradient(to right, 
        rgba(0, 123, 255, 0.1) 0%,
        rgba(0, 123, 255, 0.5) 50%,
        rgba(0, 123, 255, 0.1) 100%);
      background-size: 100% 100%;
      animation: pulse 2s infinite ease-in-out;
    }

    @keyframes pulse {
      0% { opacity: 0.8; }
      50% { opacity: 1; }
      100% { opacity: 0.8; }
    }

    .content {
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #fff;
    }

    h1 span {
      color: #5e4aff;
      font-weight: 600;
    }

    p {
      font-size: 1.1rem;
      color: #ccc;
      margin: 15px 0;
    }

    /* Estad√≠sticas */
    .stats {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      justify-content: center;
    }

    .stat-card {
      background: rgba(94, 74, 255, 0.15);
      padding: 15px 20px;
      border-radius: 12px;
      text-align: center;
      min-width: 140px;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #5e4aff;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #ccc;
      margin-top: 5px;
    }

    @media (max-width: 480px) {
      .stats {
        flex-direction: column;
        gap: 10px;
      }
    }

    .progress {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 20px 0;
    }

    .dot {
      width: 8px;
      height: 8px;
      background: #888;
      border-radius: 50%;
    }

    .dot.active {
      background: #5e4aff;
    }

    .btn-primary {
      background: linear-gradient(135deg, #5e4aff 0%, #3b2cff 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
      width: 100%;
      max-width: 400px;
    }

    .btn-primary:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(94, 74, 255, 0.5);
    }

    .login-link {
      margin-top: 20px;
      font-size: 0.9rem;
      color: #aaa;
    }

    .login-link a {
      color: #5e4aff;
      text-decoration: underline;
      font-weight: 600;
    }

    /* Formularios de login/registro */
    #registerForm,
    #loginForm {
      background: rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-radius: 15px;
      width: 100%;
      max-width: 400px;
      margin-top: 20px;
    }

    #registerForm h3,
    #loginForm h3 {
      margin-bottom: 15px;
      color: #fff;
      font-size: 1.3rem;
    }

    #registerForm input,
    #loginForm input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #444;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
    }

    #registerForm input::placeholder,
    #loginForm input::placeholder {
      color: #aaa;
    }

    #registerForm button,
    #loginForm button {
      width: 100%;
      padding: 12px;
      margin: 15px 0;
    }

    .terms {
      margin: 15px 0;
      font-size: 0.9rem;
      color: #ccc;
    }

    .terms label {
      display: block;
      margin: 8px 0;
      cursor: pointer;
    }

    .terms input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2);
    }

    .terms a {
      color: #5e4aff;
      text-decoration: underline;
    }

    .switch-form {
      text-align: center;
      margin-top: 15px;
      font-size: 0.9rem;
      color: #aaa;
    }

    .switch-form a {
      color: #5e4aff;
      text-decoration: underline;
      cursor: pointer;
    }

    .footer-links {
      margin-top: 30px;
      color: #777;
      font-size: 0.85rem;
      text-align: center;
    }

    /* Selector de instrumento */
    .instrument-select {
      width: 100%;
      padding: 10px;
      margin: 8px 0 15px;
      border-radius: 5px;
      border: 1px solid #333;
      background: #2c243a;
      color: #fff;
      font-size: 1rem;
    }

    /* App principal */
    .app-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      background: #1a132a;
      border-bottom: 1px solid #333;
      margin-bottom: 20px;
    }

    .btn-back {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .app-header h2 {
      font-size: 1.5rem;
      color: #fff;
    }

    /* Secciones generales */
    .upload-section,
    .config-section,
    .control-section,
    #stepContainer {
      background: #1a132a;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      width: 100%;
      max-width: 800px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .upload-section label,
    .config-section label,
    .control-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #fff;
    }

    .upload-section input[type="file"],
    .config-section input[type="number"],
    .control-section input[type="number"],
    .control-section input[type="range"] {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #333;
      background: #2c243a;
      color: #fff;
      font-size: 1rem;
    }

    .upload-section input[type="file"]:focus,
    .config-section input[type="number"]:focus,
    .control-section input[type="number"]:focus,
    .control-section input[type="range"]:focus {
      outline: none;
      border-color: #5e4aff;
      box-shadow: 0 0 5px rgba(94, 74, 255, 0.5);
    }

    .upload-section button,
    .config-section button,
    .control-section button {
      background: linear-gradient(135deg, #5e4aff 0%, #3b2cff 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 10px 0;
      width: 100%;
      max-width: 100%;
    }

    .upload-section button:hover,
    .config-section button:hover,
    .control-section button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(94, 74, 255, 0.3);
    }

    .hint {
      font-size: 0.9em;
      color: #aaa;
      margin: 5px 0 10px 0;
      line-height: 1.4;
    }

    /* Botones de control */
    .live-controls-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    .live-controls-row button {
      flex: 1;
      min-width: 60px;
      width: auto;
    }

    #pulseContainer {
      margin-top: 15px;
      display: flex;
      justify-content: center;
    }

    #pulseCircle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #4CAF50;
      opacity: 0.3;
      transition: opacity 0.1s;
    }

    /* Indicador fijo de comp√°s actual */
    #currentMeasureIndicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: bold;
      z-index: 1000;
    }

    /* Barra de estructura */
    #structureBar {
      position: fixed;
      top: 50px;
      left: 0;
      right: 0;
      background: #333;
      color: white;
      padding: 5px;
      text-align: center;
      z-index: 999;
    }

    /* Pie de p√°gina */
    .footer-actions {
      margin-top: 30px;
      width: 100%;
      text-align: center;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 10px 0;
      width: 100%;
      max-width: 300px;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    /* Estilos espec√≠ficos */
    #scoreContainer img,
    #scoreContainer canvas {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    /* Botones de modo */
    #toggleFormMode,
    #toggleLookMode {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      margin: 5px;
    }

    #toggleFormMode:hover,
    #toggleLookMode:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Bot√≥n de exportaci√≥n */
    #exportPractice {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 10px 0;
      width: 100%;
      max-width: 100%;
    }

    #exportPractice:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
    }

    #exportPractice:disabled {
      background: #888;
      cursor: not-allowed;
    }

    /* Ajustes de responsividad */
    @media (max-width: 768px) {
      .app-header {
        flex-direction: column;
        gap: 10px;
      }

      .btn-back {
        width: 100%;
        max-width: 100%;
      }

      .app-header h2 {
        font-size: 1.2rem;
      }

      .upload-section,
      .config-section,
      .control-section {
        padding: 15px;
        margin: 15px 0;
      }

      .live-controls-row {
        flex-direction: column;
      }

      .btn-primary {
        font-size: 1rem;
        padding: 12px 20px;
      }

      .progress {
        gap: 5px;
      }

      .dot {
        width: 6px;
        height: 6px;
      }
    }

    @media (max-width: 480px) {
      #registerForm,
      #loginForm {
        padding: 20px;
      }
      
      .content {
        padding: 0 15px;
      }
    }

    /* Paso de flujo */
    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .nav-buttons button {
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-prev {
      background: #555;
      color: white;
    }

    .btn-next {
      background: #5e4aff;
      color: white;
    }

    .btn-done {
      background: #4CAF50;
      color: white;
    }

    /* Instrucciones en pasos */
    .instructions {
      background: rgba(94, 74, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .instructions ul {
      padding-left: 20px;
      margin: 10px 0;
    }

    .instructions li {
      margin: 8px 0;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <!-- Pantalla de bienvenida -->
  <div id="welcomeScreen" class="screen">
    <div class="header">
      <div class="logo">
        <div class="icon">üéµ</div>
      </div>
      <div class="waveform"></div>
    </div>
    <div class="content">
      <h1>Domina tu <span>instrumento</span></h1>
      <p>Sincronizaci√≥n de audio y partituras en tiempo real con resaltado inteligente.</p>
      
      <!-- Estad√≠sticas -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="userCount">0</div>
          <div class="stat-label">Usuarios registrados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="downloadCount">0</div>
          <div class="stat-label">Pr√°cticas descargadas</div>
        </div>
      </div>

      <!-- Formulario de registro -->
      <div id="registerForm">
        <h3>Crear cuenta</h3>
        <input type="text" id="regName" placeholder="Nombre" />
        <input type="text" id="regLastname" placeholder="Apellidos" />
        <input type="email" id="regEmail" placeholder="Correo electr√≥nico" />
        <input type="password" id="regPassword" placeholder="Contrase√±a" />
        <input type="password" id="regConfirmPassword" placeholder="Confirmar contrase√±a" />
        
        <div class="terms">
          <label>
            <input type="checkbox" id="termsCheckbox" />
            Acepto los <a href="#" target="_blank">t√©rminos de uso</a>
          </label>
          <label>
            <input type="checkbox" id="privacyCheckbox" />
            He le√≠do la <a href="#" target="_blank">pol√≠tica de protecci√≥n de datos</a>
          </label>
        </div>
        
        <button id="registerBtn" class="btn-primary">Crear cuenta</button>
        <p class="switch-form">¬øYa tienes cuenta? <a id="showLogin">Inicia sesi√≥n</a></p>
      </div>

      <!-- Formulario de login (oculto por defecto) -->
      <div id="loginForm" style="display: none;">
        <h3>Iniciar sesi√≥n</h3>
        <input type="email" id="loginEmail" placeholder="Correo electr√≥nico" />
        <input type="password" id="loginPassword" placeholder="Contrase√±a" />
        <button id="loginBtn" class="btn-primary">Entrar</button>
        <p class="switch-form">¬øEres nuevo? <a id="showRegister">Reg√≠strate</a></p>
      </div>

      <div class="footer-links">
        <p>Tus datos se guardan √∫nicamente en tu dispositivo.</p>
      </div>
    </div>
  </div>

  <!-- App principal con flujo guiado -->
  <div id="appContainer" class="screen" style="display: none; align-items: stretch;">
    <div class="app-header">
      <button id="backToWelcome" class="btn-back">‚Üê Salir</button>
      <h2>üéµ Hola, <span id="userNameDisplay">Usuario</span></h2>
    </div>

    <div id="stepContainer">
      <!-- Paso 1: Audio -->
      <div id="step1" class="step active">
        <h3> Paso 1: Sube tu audio </h3>
        <div class="instructions">
          <p><strong>¬øQu√© debes hacer?</strong></p>
          <ul>
            <li>Selecciona un archivo de audio en formato <strong>MP3 o MP4</strong>.</li>
            <li>Debe ser la grabaci√≥n de la pieza que vas a practicar.</li>
          </ul>
        </div>
        <input type="file" id="audioFile" accept="audio/mp3,audio/mpeg,video/mp4" />
        <audio id="audioPlayer" controls style="width: 100%; margin-top: 15px;"></audio>
        <div class="nav-buttons">
          <div></div>
          <button id="next1" class="btn-next" disabled>Siguiente</button>
        </div>
      </div>

      <!-- Paso 2: Partitura e instrumento -->
      <div id="step2" class="step">
        <h3> Paso 2: Elige tu instrumento y sube tu partitura </h3>
        <div class="instructions">
          <p><strong>¬øQu√© debes hacer?</strong></p>
          <ul>
            <li>Selecciona <strong>tu instrumento</strong> de la lista (ej: Bater√≠a, Guitarra).</li>
            <li>Sube la <strong>partitura correspondiente</strong> en PDF, JPG o PNG.</li>
            <li>Puede ser una foto, escaneo o archivo digital.</li>
          </ul>
        </div>
        
        <label for="instrumentSelect">Tu instrumento:</label>
        <select id="instrumentSelect" class="instrument-select">
          <option value="">Selecciona tu instrumento</option>
          <option value="bateria">Bater√≠a</option>
          <option value="guitarra">Guitarra</option>
          <option value="bajo">Bajo</option>
          <option value="piano">Piano/Teclado</option>
          <option value="voz">Voz</option>
          <option value="saxo">Saxo</option>
          <option value="trompeta">Trompeta</option>
          <option value="violin">Viol√≠n</option>
          <option value="flauta">Flauta</option>
          <option value="otro">Otro</option>
        </select>

        <label for="scoreFile">Tu partitura (PDF, JPG o PNG):</label>
        <input type="file" id="scoreFile" accept=".pdf,.jpg,.jpeg,.png" />
        <div id="scoreContainer" style="margin-top: 15px; text-align: center; min-height: 300px;"></div>
        <div class="nav-buttons">
          <button id="prev2" class="btn-prev">Anterior</button>
          <button id="next2" class="btn-next" disabled>Siguiente</button>
        </div>
      </div>

      <!-- Paso 3: Sincronizaci√≥n -->
      <div id="step3" class="step">
        <h3> Paso 3: Sincroniza audio y partitura </h3>
        <div class="instructions">
          <p><strong>¬øQu√© debes hacer?</strong></p>
          <ul>
            <li><strong>Reproduce el audio</strong> desde el principio.</li>
            <li>En el <strong>momento exacto</strong> en que suena la primera nota de tu instrumento, haz clic en el bot√≥n de abajo.</li>
            <li>¬°Eso es todo! La app se encargar√° de alinear la partitura con el audio.</li>
          </ul>
        </div>
        <button id="markFirstNote" class="btn-primary">La primera nota entra aqu√≠</button>
        <p id="offsetStatus" style="margin: 15px 0;">Desfase: 0s</p>
        <div class="nav-buttons">
          <button id="prev3" class="btn-prev">Anterior</button>
          <button id="next3" class="btn-done">¬°Listo! Practicar ahora</button>
        </div>
      </div>

      <!-- Paso 4: Practica (todo el resto) -->
      <div id="step4" class="step">
        <h3>üéµ ¬°Ya puedes practicar!</h3>
        
        <!-- Aqu√≠ va todo lo dem√°s: BPM, loop, controles, etc. -->
        <!-- Etapa 2: Sincronizaci√≥n r√≠tmica -->
        <section id="rhythmSection" class="control-section">
          <label for="bpmInput">BPM (beats per minute):</label>
          <p class="hint">Escribe el tempo de la pieza (ej. 120). La app usar√° esto para marcar los compases.</p>
          <input type="number" id="bpmInput" min="20" max="300" placeholder="Ej. 120" />
          <button id="startSync">Iniciar sincronizaci√≥n r√≠tmica</button>
          <button id="stopSync">Detener</button>
          <p id="measureInfo">Duraci√≥n de comp√°s: -- segundos</p>
          <label>
            <input type="checkbox" id="followMode" checked />
            Modo ‚Äúseguir siempre‚Äù (no se detiene)
          </label>
        </section>

        <!-- Etapa 3: Controles en vivo + loop -->
        <section id="liveControlsSection" class="control-section">
          <h3>üéõÔ∏è Controles en vivo</h3>
          <div class="live-controls-row">
            <button id="offsetMinus">‚Äì 0.2s</button>
            <button id="offsetPlus">+ 0.2s</button>
          </div>
          <p>Offset aplicado: <span id="liveOffsetDisplay">0s</span></p>

          <h3>‚è≠Ô∏è Saltos por compases</h3>
          <div class="live-controls-row">
            <button id="jumpBack2">‚óÑ‚óÑ 2</button>
            <button id="jumpBack1">‚óÑ 1</button>
            <button id="jumpForward1">1 ‚ñ∫</button>
            <button id="jumpForward2">2 ‚ñ∫‚ñ∫</button>
          </div>

          <h3>üîÅ Loop por secci√≥n</h3>
          <label>Desde comp√°s: <input type="number" id="loopFrom" min="1" value="1" /></label>
          <label>Hasta comp√°s: <input type="number" id="loopTo" min="1" value="4" /></label>
          <br />
          <button id="setLoop">Establecer loop</button>
          <button id="clearLoop">Limpiar loop</button>
          <p id="loopStatus">Sin loop activo</p>
        </section>

        <!-- Etapa 4-7 y descarga -->
        <section id="advancedSection" class="control-section">
          <button id="toggleFormMode">Modo ‚Äúsolo forma‚Äù</button>
          <button id="toggleLookMode">Modo ‚Äúsolo mirar‚Äù</button>
          <button id="startCountdown">Iniciar cuenta atr√°s</button>
          <button id="exportPractice" disabled>üíæ Descargar pr√°ctica offline</button>
        </section>

        <!-- Indicadores fijos -->
        <div id="structureBar" style="display: none; position: fixed; top: 50px; left: 0; right: 0; background: #333; color: white; padding: 5px; text-align: center; z-index: 999;"></div>
        <div id="currentMeasureIndicator" style="display: none;">Comp√°s actual: <span id="currentMeasureNumber">0</span></div>
      </div>
    </div>
  </div>

  <!-- PDF.js -->
  <script src="pdfjs/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.min.js';</script>

  <!-- Librer√≠as para ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- Script completo -->
  <script>
    // === Claves globales ===
    const usersKey = 'musicApp_users';
    const currentUserKey = 'musicApp_currentUser';
    const USER_COUNT_KEY = 'musicApp_userCount';
    const DOWNLOAD_COUNT_KEY = 'musicApp_downloadCount';
    const isAdminKey = 'musicApp_isAdmin';

    const ADMIN_EMAIL = 'admin@mimusicapp.com';
    const ADMIN_PASSWORD = 'admin123';

    let currentAudioFileName = null;
    let currentOffset = 0;
    let bpm = 0;
    let measureDuration = 0;
    let currentAudioFile = null;
    let currentScoreFile = null;

    // === DOM Elements (pasos) ===
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const next1 = document.getElementById('next1');
    const next2 = document.getElementById('next2');
    const next3 = document.getElementById('next3');
    const prev2 = document.getElementById('prev2');
    const prev3 = document.getElementById('prev3');

    const audioFileInput = document.getElementById('audioFile');
    const audioPlayer = document.getElementById('audioPlayer');
    const scoreFileInput = document.getElementById('scoreFile');
    const scoreContainer = document.getElementById('scoreContainer');
    const markFirstNoteBtn = document.getElementById('markFirstNote');
    const offsetStatus = document.getElementById('offsetStatus');
    const instrumentSelect = document.getElementById('instrumentSelect');

    // === Manejo de pasos ===
    function showStep(stepId) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(stepId).classList.add('active');
    }

    next1.addEventListener('click', () => showStep('step2'));
    prev2.addEventListener('click', () => showStep('step1'));
    next2.addEventListener('click', () => showStep('step3'));
    prev3.addEventListener('click', () => showStep('step2'));
    next3.addEventListener('click', () => showStep('step4'));

    // === Audio ===
    audioFileInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      currentAudioFile = file;
      currentAudioFileName = file.name;
      const url = URL.createObjectURL(file);
      audioPlayer.src = url;
      next1.disabled = false;
    });

    // === Partitura ===
    scoreFileInput.addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (!file) return;
      currentScoreFile = file;
      scoreContainer.innerHTML = '<p>Cargando...</p>';

      if (file.type === 'application/pdf') {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const typedarray = new Uint8Array(arrayBuffer);
          const pdf = await pdfjsLib.getDocument({  typedarray }).promise;
          const page = await pdf.getPage(1);
          const scale = 1.5;
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement('canvas');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          scoreContainer.innerHTML = '';
          scoreContainer.appendChild(canvas);
          const context = canvas.getContext('2d');
          await page.render({ canvasContext: context, viewport }).promise;
          next2.disabled = false;
        } catch (e) {
          const url = URL.createObjectURL(file);
          const embed = document.createElement('embed');
          embed.src = url;
          embed.type = 'application/pdf';
          embed.width = '100%';
          embed.height = '500px';
          scoreContainer.innerHTML = '';
          scoreContainer.appendChild(embed);
          next2.disabled = false;
        }
      } else if (file.type.startsWith('image/')) {
        const url = URL.createObjectURL(file);
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = '100%';
        scoreContainer.innerHTML = '';
        scoreContainer.appendChild(img);
        next2.disabled = false;
      } else {
        scoreContainer.innerHTML = '<p>Formato no soportado.</p>';
      }
    });

    // === Sincronizaci√≥n ===
    markFirstNoteBtn.addEventListener('click', function () {
      if (!currentAudioFileName) return;
      const currentTime = audioPlayer.currentTime;
      currentOffset = -currentTime;
      offsetStatus.textContent = `Desfase: ${currentOffset.toFixed(1)}s`;
    });

    // === Resto de funcionalidades (BPM, loop, etc.) ===
    document.getElementById('startSync').addEventListener('click', () => {
      const value = parseFloat(document.getElementById('bpmInput').value);
      if (isNaN(value) || value <= 0) {
        alert('Ingresa un BPM v√°lido.');
        return;
      }
      bpm = value;
      measureDuration = 60 / bpm;
      document.getElementById('measureInfo').textContent = `Duraci√≥n de comp√°s: ${measureDuration.toFixed(2)}s`;
    });

    // === ‚úÖ FUNCI√ìN LOGIN CORREGIDA ===
    function login(email, password) {
      // ‚úÖ Primero: verificar admin
      if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
        localStorage.setItem(isAdminKey, 'true');
        return { name: 'Administrador', lastname: '', email, admin: true };
      }
      
      // Luego: verificar usuarios normales
      const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      const user = users.find(u => u.email === email && u.password === password);
      if (user) {
        localStorage.setItem(currentUserKey, email);
        localStorage.removeItem(isAdminKey);
        return { name: user.name, lastname: user.lastname, email, admin: false };
      }
      return null;
    }

    // === Resto igual ===
    function saveUser(name, lastname, email, password) {
      let users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      const exists = users.some(u => u.email === email);
      if (!exists) {
        users.push({ name, lastname, email, password });
        localStorage.setItem(usersKey, JSON.stringify(users));
        const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0') + 1;
        localStorage.setItem(USER_COUNT_KEY, userCount.toString());
      }
      localStorage.setItem(currentUserKey, email);
      return { name, lastname, email };
    }

    function logout() {
      localStorage.removeItem(currentUserKey);
      localStorage.removeItem(isAdminKey);
    }

    function displayStats() {
      const userCountEl = document.getElementById('userCount');
      const downloadCountEl = document.getElementById('downloadCount');
      if (userCountEl && downloadCountEl) {
        const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0');
        const downloadCount = parseInt(localStorage.getItem(DOWNLOAD_COUNT_KEY) || '0');
        userCountEl.textContent = userCount;
        downloadCountEl.textContent = downloadCount;
      }
    }

    // === Inicializaci√≥n ===
    document.addEventListener('DOMContentLoaded', () => {
      displayStats();

      // Activar "Inicia sesi√≥n"
      document.getElementById('showLogin').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
      });

      // Login
      document.getElementById('loginBtn').addEventListener('click', () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const user = login(email, password);
        if (user) {
          if (user.admin) {
            alert('Acceso de administrador no compatible con el flujo guiado.\nUsa la versi√≥n anterior para administrar.');
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'flex';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            return;
          } else {
            document.getElementById('userNameDisplay').textContent = `${user.name} ${user.lastname}`;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
          }
        } else {
          alert('Correo o contrase√±a incorrectos.');
        }
      });

      // Registro
      document.getElementById('registerBtn').addEventListener('click', () => {
        const name = document.getElementById('regName').value.trim();
        const lastname = document.getElementById('regLastname').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regConfirmPassword').value;
        const terms = document.getElementById('termsCheckbox').checked;
        const privacy = document.getElementById('privacyCheckbox').checked;

        if (!name || !lastname || !email || !password || !confirmPassword) {
          alert('Por favor, completa todos los campos.');
          return;
        }
        if (password !== confirmPassword) {
          alert('Las contrase√±as no coinciden.');
          return;
        }
        if (!terms || !privacy) {
          alert('Debes aceptar los t√©rminos y la pol√≠tica de privacidad.');
          return;
        }
        if (!email.includes('@')) {
          alert('Por favor, ingresa un correo v√°lido.');
          return;
        }

        const user = saveUser(name, lastname, email, password);
        document.getElementById('userNameDisplay').textContent = `${user.name} ${user.lastname}`;
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'flex';
      });

      // Salir
      document.getElementById('backToWelcome').addEventListener('click', () => {
        logout();
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('welcomeScreen').style.display = 'flex';
      });

      // "Reg√≠strate" desde login
      document.getElementById('showRegister').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
      });
    });
  </script>
</body>
</html>
