<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Domina tu instrumento</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f0c1a;
      color: white;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #1a132a;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #5e4aff;
    }
    .section {
      background: #251e35;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .section h2 {
      margin-bottom: 15px;
      color: #5e4aff;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2c243a;
      color: white;
      font-size: 1rem;
    }
    button {
      background: linear-gradient(135deg, #5e4aff 0%, #3b2cff 100%);
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    #scoreContainer {
      height: 500px;
      margin: 15px 0;
      border: 1px dashed #555;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      overflow: hidden;
      position: relative;
    }
    #scoreContent {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    #currentMeasureIndicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(231, 76, 60, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      z-index: 1000;
    }
    .hint {
      font-size: 0.9rem;
      color: #aaa;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ Domina tu instrumento</h1>
    
    <div class="section">
      <h2>1. Prepara tu pr√°ctica</h2>
      <p class="hint">Sube tu audio, tu partitura y elige tu instrumento. ¬°La app har√° el resto!</p>
      
      <label>Audio (MP3 o MP4):</label>
      <input type="file" id="audioFile" accept="audio/mp3,audio/mpeg,video/mp4" />
      
      <label>Partitura (PDF, JPG o PNG):</label>
      <input type="file" id="scoreFile" accept=".pdf,.jpg,.jpeg,.png" />
      
      <label>Tu instrumento:</label>
      <select id="instrumentSelect">
        <option value="">Selecciona tu instrumento</option>
        <option value="bateria">Bater√≠a</option>
        <option value="guitarra">Guitarra</option>
        <option value="bajo">Bajo</option>
        <option value="piano">Piano/Teclado</option>
        <option value="voz">Voz</option>
        <option value="saxo">Saxo</option>
        <option value="trompeta">Trompeta</option>
        <option value="violin">Viol√≠n</option>
        <option value="flauta">Flauta</option>
        <option value="otro">Otro</option>
      </select>
      
      <audio id="audioPlayer" controls style="width: 100%; margin: 15px 0; background: #2c243a; padding: 10px; border-radius: 6px;"></audio>
      <div id="scoreContainer">
        <img id="scoreContent" src="" style="display: none;" />
      </div>
    </div>

    <div class="section">
      <h2>2. ¬°Practica!</h2>
      <p class="hint">La partitura se resaltar√° autom√°ticamente en tiempo real mientras suena el audio.</p>
      <button id="startPractice">‚ñ∂Ô∏è Empezar a practicar</button>
    </div>
  </div>

  <div id="currentMeasureIndicator" style="display: none;">
    Comp√°s: <span id="measureNumber">0</span>
  </div>

  <!-- PDF.js -->
  <script src="pdfjs/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.min.js';</script>

  <script>
    // === CONFIGURACI√ìN ===
    const ADMIN_EMAIL = 'admin@mimusicapp.com';
    const ADMIN_PASSWORD = 'admin123';
    const usersKey = 'musicApp_users';
    const currentUserKey = 'musicApp_currentUser';
    const USER_COUNT_KEY = 'musicApp_userCount';
    const DOWNLOAD_COUNT_KEY = 'musicApp_downloadCount';
    const isAdminKey = 'musicApp_isAdmin';

    // === ESTADO ===
    let currentAudioFile = null;
    let currentScoreFile = null;
    let currentInstrument = '';
    let currentOffset = 0;
    let bpm = 120;
    let measureDuration = 60 / bpm;
    let syncInterval = null;
    let canvas = null;
    let canvasCtx = null;

    // === ELEMENTOS ===
    const audioFileInput = document.getElementById('audioFile');
    const scoreFileInput = document.getElementById('scoreFile');
    const instrumentSelect = document.getElementById('instrumentSelect');
    const startPracticeBtn = document.getElementById('startPractice');
    const audioPlayer = document.getElementById('audioPlayer');
    const scoreContainer = document.getElementById('scoreContainer');
    const scoreContent = document.getElementById('scoreContent');
    const measureNumberEl = document.getElementById('measureNumber');

    // === CARGAR AUDIO ===
    audioFileInput.addEventListener('change', (e) => {
      currentAudioFile = e.target.files[0];
      if (currentAudioFile) {
        const url = URL.createObjectURL(currentAudioFile);
        audioPlayer.src = url;
      }
    });

    // === CARGAR PARTITURA EN CANVAS (SOLUCI√ìN DEFINITIVA) ===
    scoreFileInput.addEventListener('change', async (e) => {
      currentScoreFile = e.target.files[0];
      if (!currentScoreFile) return;

      // Configurar canvas
      if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.id = 'scoreCanvas';
        canvas.style.position = 'absolute';
        canvas.style.top = '0';
        canvas.style.left = '0';
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        canvas.style.zIndex = '5';
        scoreContainer.appendChild(canvas);
        canvasCtx = canvas.getContext('2d');
      }

      try {
        if (currentScoreFile.type === 'application/pdf') {
          const arrayBuffer = await currentScoreFile.arrayBuffer();
          const typedarray = new Uint8Array(arrayBuffer);
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          const page = await pdf.getPage(1);
          
          // Ajustar al contenedor
          const scale = Math.min(
            scoreContainer.clientWidth / page.getViewport({ scale: 1 }).width,
            scoreContainer.clientHeight / page.getViewport({ scale: 1 }).height
          );
          const viewport = page.getViewport({ scale });
          
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          await page.render({ canvasContext: canvasCtx, viewport }).promise;
        } else if (currentScoreFile.type.startsWith('image/')) {
          const img = new Image();
          const url = URL.createObjectURL(currentScoreFile);
          img.onload = () => {
            const scale = Math.min(
              scoreContainer.clientWidth / img.width,
              scoreContainer.clientHeight / img.height
            );
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            canvasCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
            URL.revokeObjectURL(url);
          };
          img.src = url;
        }
      } catch (e) {
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        canvasCtx.fillStyle = '#ff6b6b';
        canvasCtx.font = '16px Arial';
        canvasCtx.fillText('Error al cargar partitura', 10, 30);
      }
    });

    // === SELECCIONAR INSTRUMENTO ===
    instrumentSelect.addEventListener('change', () => {
      currentInstrument = instrumentSelect.value;
    });

    // === RESALTADO DIRECTO EN CANVAS (100% ANCLADO) ===
    function highlightMeasure(index) {
      if (!canvas || !canvasCtx || !currentScoreFile) return;
      
      // Redibujar partitura
      scoreFileInput.dispatchEvent(new Event('change'));
      
      // Esperar a que se redibuje
      setTimeout(() => {
        const measuresPerLine = 4;
        const measureWidth = canvas.width / measuresPerLine;
        const lineHeight = canvas.height * 0.2;
        const line = Math.floor(index / measuresPerLine);
        const col = index % measuresPerLine;
        
        if (line * lineHeight < canvas.height) {
          canvasCtx.fillStyle = 'rgba(255, 255, 0, 0.3)';
          canvasCtx.fillRect(col * measureWidth, line * lineHeight, measureWidth, lineHeight);
        }
      }, 10);
    }

    // === SINCRONIZACI√ìN ===
    function startSync() {
      document.getElementById('currentMeasureIndicator').style.display = 'block';
      measureDuration = 60 / bpm;
      
      if (syncInterval) clearInterval(syncInterval);
      syncInterval = setInterval(() => {
        const audioTime = audioPlayer.currentTime;
        const syncTime = audioTime + currentOffset;
        const currentMeasure = syncTime >= 0 ? Math.floor(syncTime / measureDuration) : -1;
        measureNumberEl.textContent = currentMeasure + 1;
        highlightMeasure(currentMeasure);
      }, 100);
    }

    // === EMPEZAR PR√ÅCTICA ===
    startPracticeBtn.addEventListener('click', () => {
      if (!currentAudioFile || !currentScoreFile || !currentInstrument) {
        alert('Por favor, sube el audio, la partitura y elige tu instrumento.');
        return;
      }
      startSync();
    });

    // === LOGIN/REGISTRO/ADMIN (SIN CAMBIOS) ===
    function saveUser(name, lastname, email, password) {
      let users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      const exists = users.some(u => u.email === email);
      if (!exists) {
        users.push({ name, lastname, email, password });
        localStorage.setItem(usersKey, JSON.stringify(users));
        const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0') + 1;
        localStorage.setItem(USER_COUNT_KEY, userCount.toString());
      }
      localStorage.setItem(currentUserKey, email);
      return { name, lastname, email };
    }

    function login(email, password) {
      if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
        localStorage.setItem(isAdminKey, 'true');
        return { name: 'Administrador', lastname: '', email, admin: true };
      }
      const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      const user = users.find(u => u.email === email && u.password === password);
      if (user) {
        localStorage.setItem(currentUserKey, email);
        localStorage.removeItem(isAdminKey);
        return { name: user.name, lastname: user.lastname, email, admin: false };
      }
      return null;
    }

    function displayStats() {
      const userCountEl = document.getElementById('userCount');
      const downloadCountEl = document.getElementById('downloadCount');
      if (userCountEl && downloadCountEl) {
        const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0');
        const downloadCount = parseInt(localStorage.getItem(DOWNLOAD_COUNT_KEY) || '0');
        userCountEl.textContent = userCount;
        downloadCountEl.textContent = downloadCount;
      }
    }

    function restoreSession() {
      const isAdmin = localStorage.getItem(isAdminKey) === 'true';
      const userEmail = localStorage.getItem(currentUserKey);
      const welcomeScreen = document.querySelector('.screen');
      const appContainer = document.querySelector('#appContainer');
      const userNameDisplay = document.getElementById('userNameDisplay');

      if (isAdmin) {
        userNameDisplay.textContent = 'Administrador';
        welcomeScreen.style.display = 'none';
        appContainer.style.display = 'block';
        setTimeout(() => {
          appContainer.style.display = 'none';
          welcomeScreen.style.display = 'flex';
        }, 100);
      } else if (userEmail) {
        const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
        const user = users.find(u => u.email === userEmail);
        if (user) {
          userNameDisplay.textContent = `${user.name} ${user.lastname}`;
          welcomeScreen.style.display = 'none';
          appContainer.style.display = 'block';
          return;
        }
      }
      welcomeScreen.style.display = 'flex';
      appContainer.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
      displayStats();
      restoreSession();

      document.getElementById('showLogin')?.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
      });

      document.getElementById('loginBtn')?.addEventListener('click', () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const user = login(email, password);
        if (user) {
          if (user.admin) {
            document.getElementById('userNameDisplay').textContent = 'Administrador';
            document.querySelector('#welcomeScreen').style.display = 'none';
            document.querySelector('#appContainer').style.display = 'block';
            setTimeout(() => {
              document.querySelector('#appContainer').style.display = 'none';
              document.querySelector('#welcomeScreen').style.display = 'flex';
              document.getElementById('loginEmail').value = '';
              document.getElementById('loginPassword').value = '';
            }, 100);
          } else {
            document.getElementById('userNameDisplay').textContent = `${user.name} ${user.lastname}`;
            document.querySelector('#welcomeScreen').style.display = 'none';
            document.querySelector('#appContainer').style.display = 'block';
          }
        } else {
          alert('Correo o contrase√±a incorrectos.');
        }
      });

      document.getElementById('registerBtn')?.addEventListener('click', () => {
        const name = document.getElementById('regName').value.trim();
        const lastname = document.getElementById('regLastname').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regConfirmPassword').value;
        const terms = document.getElementById('termsCheckbox').checked;
        const privacy = document.getElementById('privacyCheckbox').checked;

        if (!name || !lastname || !email || !password || !confirmPassword) {
          alert('Por favor, completa todos los campos.');
          return;
        }
        if (password !== confirmPassword) {
          alert('Las contrase√±as no coinciden.');
          return;
        }
        if (!terms || !privacy) {
          alert('Debes aceptar los t√©rminos y la pol√≠tica de privacidad.');
          return;
        }
        if (!email.includes('@')) {
          alert('Por favor, ingresa un correo v√°lido.');
          return;
        }

        const user = saveUser(name, lastname, email, password);
        document.getElementById('userNameDisplay').textContent = `${user.name} ${user.lastname}`;
        document.querySelector('#welcomeScreen').style.display = 'none';
        document.querySelector('#appContainer').style.display = 'block';
      });

      document.getElementById('showRegister')?.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
      });

      document.getElementById('backToWelcome')?.addEventListener('click', () => {
        localStorage.removeItem(currentUserKey);
        localStorage.removeItem(isAdminKey);
        document.querySelector('#appContainer').style.display = 'none';
        document.querySelector('#welcomeScreen').style.display = 'flex';
      });
    });
  </script>
</body>
</html>
