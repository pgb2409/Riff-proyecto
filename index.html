<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Domina tu instrumento</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Pantalla de bienvenida -->
  <div id="welcomeScreen" class="screen">
    <div class="header">
      <div class="logo">
        <div class="icon">üéµ</div>
      </div>
      <div class="waveform"></div>
    </div>
    <div class="content">
      <h1>Domina tu <span>instrumento</span></h1>
      <p>Sincronizaci√≥n de audio y partituras en tiempo real con resaltado inteligente.</p>
      
      <!-- Estad√≠sticas -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="userCount">0</div>
          <div class="stat-label">Usuarios registrados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="downloadCount">0</div>
          <div class="stat-label">Pr√°cticas descargadas</div>
        </div>
      </div>

      <!-- Formulario de registro -->
      <div id="registerForm">
        <h3>Crear cuenta</h3>
        <input type="text" id="regName" placeholder="Nombre" />
        <input type="text" id="regLastname" placeholder="Apellidos" />
        <input type="email" id="regEmail" placeholder="Correo electr√≥nico" />
        <input type="password" id="regPassword" placeholder="Contrase√±a" />
        <input type="password" id="regConfirmPassword" placeholder="Confirmar contrase√±a" />
        
        <div class="terms">
          <label>
            <input type="checkbox" id="termsCheckbox" />
            Acepto los <a href="#" target="_blank">t√©rminos de uso</a>
          </label>
          <label>
            <input type="checkbox" id="privacyCheckbox" />
            He le√≠do la <a href="#" target="_blank">pol√≠tica de protecci√≥n de datos</a>
          </label>
        </div>
        
        <button id="registerBtn" class="btn-primary">Crear cuenta</button>
        <p class="switch-form">¬øYa tienes cuenta? <a id="showLogin">Inicia sesi√≥n</a></p>
      </div>

      <!-- Formulario de login (oculto por defecto) -->
      <div id="loginForm" style="display: none;">
        <h3>Iniciar sesi√≥n</h3>
        <input type="email" id="loginEmail" placeholder="Correo electr√≥nico" />
        <input type="password" id="loginPassword" placeholder="Contrase√±a" />
        <button id="loginBtn" class="btn-primary">Entrar</button>
        <p class="switch-form">¬øEres nuevo? <a id="showRegister">Reg√≠strate</a></p>
      </div>

      <div class="footer-links">
        <p>Tus datos se guardan √∫nicamente en tu dispositivo.</p>
      </div>
    </div>
  </div>

  <!-- App principal (alumno) -->
  <div id="appContainer" class="screen" style="display: none;">
    <!-- ... contenido igual que antes ... -->
    <!-- (todo el contenido de la app del alumno se mantiene intacto) -->
    <div class="app-header">
      <button id="backToWelcome" class="btn-back">‚Üê Salir</button>
      <h2>üéµ Hola, <span id="userNameDisplay">Usuario</span></h2>
    </div>

    <!-- Audio Upload -->
    <section class="upload-section">
      <label for="audioFile">Sube tu audio (MP3 o MP4):</label>
      <p class="hint">Selecciona la grabaci√≥n de la pieza que vas a practicar.</p>
      <input type="file" id="audioFile" accept="audio/mp3,audio/mpeg,video/mp4" />
      <br />
      <audio id="audioPlayer" controls style="width: 100%; margin-top: 10px;"></audio>
      <br />
      <button id="markFirstNote" disabled>La primera nota entra aqu√≠</button>
      <p class="hint">Reproduce el audio y haz clic en este bot√≥n exactamente cuando suene la primera nota. Esto sincroniza la partitura con el audio.</p>
    </section>

    <!-- Score Upload -->
    <section class="upload-section">
      <label for="scoreFile">Sube la partitura de tu instrumento (PDF, JPG o PNG):</label>
      <p class="hint">Ej: partitura de bater√≠a, tablatura de guitarra, hoja de acordes, etc.</p>
      
      <label for="instrumentSelect">Elige tu instrumento:</label>
      <select id="instrumentSelect" class="instrument-select">
        <option value="">Selecciona tu instrumento</option>
        <option value="bateria">Bater√≠a</option>
        <option value="guitarra">Guitarra</option>
        <option value="bajo">Bajo</option>
        <option value="piano">Piano/Teclado</option>
        <option value="voz">Voz</option>
        <option value="saxo">Saxo</option>
        <option value="trompeta">Trompeta</option>
        <option value="violin">Viol√≠n</option>
        <option value="flauta">Flauta</option>
        <option value="otro">Otro</option>
      </select>

      <input type="file" id="scoreFile" accept=".pdf,.jpg,.jpeg,.png" />
      <div id="scoreContainer" style="margin-top: 10px; text-align: center; min-height: 400px;"></div>
      <p id="instrumentStatus" class="hint" style="margin-top: 10px; font-weight: bold; color: #5e4aff;"></p>
    </section>

    <!-- Modo Profesor (Etapa 6) -->
    <section id="teacherModeSection" class="config-section">
      <h3>üë®‚Äçüè´ Modo profesor</h3>
      <p class="hint">Configura BPM, offset y secciones para compartir con tus alumnos.</p>
      <label for="teacherBpm">BPM:</label>
      <input type="number" id="teacherBpm" min="20" max="300" placeholder="120" />
      
      <label for="teacherOffset">Offset (segundos):</label>
      <input type="number" id="teacherOffset" step="0.1" placeholder="0" />
      
      <label for="structureMarks">Marcas de estructura (opcional):</label>
      <p class="hint">Ej: "1:Intro,4:Verso,8:Estribillo" (comp√°s:nombre)</p>
      <input type="text" id="structureMarks" placeholder="1:Intro,4:Verso" style="width: 100%;" />
      
      <label>Rango de loop:</label>
      <div style="display: flex; gap: 10px;">
        <input type="number" id="teacherLoopFrom" min="1" placeholder="Desde" />
        <input type="number" id="teacherLoopTo" min="1" placeholder="Hasta" />
      </div>
      
      <button id="generateLink">Generar enlace para compartir</button>
      <p id="shareLink" style="word-break: break-all; margin-top: 10px; display: none;"></p>
    </section>

    <!-- Offset Display -->
    <section class="control-section">
      <p id="offsetStatus">Desfase actual: 0s (ajustado autom√°ticamente o manual)</p>
      <label for="manualOffset">Ajuste manual (segundos):</label>
      <p class="hint">Si la partitura va adelantada o atrasada, ajusta aqu√≠ en peque√±os pasos (ej. +0.2 o -0.3).</p>
      <input type="number" id="manualOffset" step="0.1" value="0" />
      <button id="applyManualOffset">Aplicar ajuste manual</button>
    </section>

    <!-- Etapa 2: Sincronizaci√≥n r√≠tmica -->
    <section id="rhythmSection" class="control-section">
      <label for="bpmInput">BPM (beats per minute):</label>
      <p class="hint">Escribe el tempo de la pieza (ej. 120). La app usar√° esto para marcar los compases.</p>
      <input type="number" id="bpmInput" min="20" max="300" placeholder="Ej. 120" />
      <button id="startSync">Iniciar sincronizaci√≥n r√≠tmica</button>
      <button id="stopSync">Detener</button>
      <p id="measureInfo">Duraci√≥n de comp√°s: -- segundos</p>
      <label>
        <input type="checkbox" id="followMode" checked />
        Modo ‚Äúseguir siempre‚Äù (no se detiene)
      </label>
      <p class="hint">Si activas esta opci√≥n, el resaltado de compases seguir√° avanzando aunque te pierdas.</p>
    </section>

    <!-- Etapa 3: Controles en vivo + loop -->
    <section id="liveControlsSection" class="control-section">
      <h3>üéõÔ∏è Controles en vivo (ajuste fino)</h3>
      <p class="hint">Ajusta la sincronizaci√≥n sobre la marcha mientras practicas.</p>
      <div class="live-controls-row">
        <button id="offsetMinus">‚Äì 0.2s</button>
        <button id="offsetPlus">+ 0.2s</button>
      </div>
      <p>Offset aplicado: <span id="liveOffsetDisplay">0s</span></p>

      <h3>‚è≠Ô∏è Saltos por compases</h3>
      <p class="hint">Avanza o retrocede compases para repetir secciones dif√≠ciles.</p>
      <div class="live-controls-row">
        <button id="jumpBack2">‚óÑ‚óÑ 2</button>
        <button id="jumpBack1">‚óÑ 1</button>
        <button id="jumpForward1">1 ‚ñ∫</button>
        <button id="jumpForward2">2 ‚ñ∫‚ñ∫</button>
      </div>

      <h3>üîÅ Loop por secci√≥n</h3>
      <p class="hint">Repite una secci√≥n autom√°ticamente (ej. compases 5 a 8).</p>
      <label>
        Desde comp√°s:
        <input type="number" id="loopFrom" min="1" value="1" />
      </label>
      <label>
        Hasta comp√°s:
        <input type="number" id="loopTo" min="1" value="4" />
      </label>
      <br />
      <button id="setLoop">Establecer loop</button>
      <button id="clearLoop">Limpiar loop</button>
      <p id="loopStatus">Sin loop activo</p>
    </section>

    <!-- Etapa 4: Feedback visual r√≠tmico -->
    <section id="visualFeedbackSection" class="control-section">
      <h3>üëÅÔ∏è Feedback visual r√≠tmico</h3>
      <p class="hint">Prep√°rate antes de tocar: ver√°s un pulso visual que marca el ritmo durante un comp√°s.</p>
      <button id="startCountdown">Iniciar cuenta atr√°s (1 comp√°s)</button>
      <div id="pulseContainer">
        <div id="pulseCircle"></div>
      </div>
    </section>

    <!-- Etapa 5: Modos de visualizaci√≥n -->
    <section id="viewModesSection" class="control-section">
      <h3>üëÅÔ∏è Modos de visualizaci√≥n</h3>
      <p class="hint">Elige c√≥mo quieres ver la pr√°ctica.</p>
      <button id="toggleFormMode">Modo ‚Äúsolo forma‚Äù</button>
      <button id="toggleLookMode">Modo ‚Äúsolo mirar‚Äù</button>
      <p id="modeStatus">Modo actual: Normal</p>
      <p class="hint">‚Ä¢ <strong>Solo forma</strong>: oculta la partitura, √∫til para memorizar.  
         ‚Ä¢ <strong>Solo mirar</strong>: avanza sin audio, ideal para estudiar el ritmo antes de tocar.</p>
    </section>

    <!-- Etapa 7: Mejoras avanzadas -->
    <section id="advancedFeaturesSection" class="control-section">
      <h3>üî¨ Mejoras avanzadas</h3>
      
      <label for="playbackRate">Velocidad de reproducci√≥n:</label>
      <p class="hint">Ajusta la velocidad sin cambiar el tono (si el navegador lo permite).</p>
      <input type="range" id="playbackRate" min="0.5" max="2" step="0.1" value="1" />
      <span id="playbackRateValue">1x</span>
      
      <button id="detectBpm" style="margin-top: 10px;">Detectar BPM autom√°ticamente</button>
      <p id="bpmDetectionStatus" style="font-size: 0.9em; color: #555;"></p>
    </section>

    <!-- ‚úÖ DESCARGA FINAL -->
    <section id="exportSection" class="control-section">
      <h3>üíæ Descargar pr√°ctica para usar sin internet</h3>
      <p class="hint">Una vez configurado todo, descarga un archivo ZIP listo para usar sin conexi√≥n.</p>
      <button id="exportPractice" disabled>.Descargar pr√°ctica sincronizada</button>
    </section>

    <!-- Marcas de estructura -->
    <div id="structureBar" style="display: none; position: fixed; top: 50px; left: 0; right: 0; background: #333; color: white; padding: 5px; text-align: center; z-index: 999;"></div>
    <div id="currentMeasureIndicator" style="display: none;">Comp√°s actual: <span id="currentMeasureNumber">0</span></div>

    <!-- PDF.js -->
    <script src="pdfjs/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.min.js';</script>

    <!-- Librer√≠as para ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="script.js"></script>
  </div>

  <!-- ‚úÖ PANEL DE ADMINISTRACI√ìN (NUEVO) -->
  <div id="adminPanel" class="screen" style="display: none; text-align: left; max-width: 800px;">
    <div class="app-header">
      <button id="backToAdminWelcome" class="btn-back">‚Üê Salir del panel</button>
      <h2>üîë Panel de Administraci√≥n</h2>
    </div>

    <section class="control-section">
      <h3>üìä Estad√≠sticas</h3>
      <p><strong>Usuarios registrados:</strong> <span id="adminUserCount">0</span></p>
      <p><strong>Pr√°cticas descargadas:</strong> <span id="adminDownloadCount">0</span></p>
    </section>

    <section class="control-section">
      <h3>üë• Lista de usuarios</h3>
      <div id="adminUserList" style="max-height: 300px; overflow-y: auto;">
        <!-- Se llenar√° con JS -->
      </div>
    </section>

    <section class="control-section">
      <h3>üõ†Ô∏è Herramientas</h3>
      <button id="resetCounters" class="btn-primary" style="background: #ff6b6b;">Restablecer contadores</button>
    </section>
  </div>

  <!-- Script (igual que antes, pero con l√≥gica de admin a√±adida) -->
  <script>
    // === Claves globales ===
    const usersKey = 'musicApp_users';
    const currentUserKey = 'musicApp_currentUser';
    const USER_COUNT_KEY = 'musicApp_userCount';
    const DOWNLOAD_COUNT_KEY = 'musicApp_downloadCount';
    const isAdminKey = 'musicApp_isAdmin';

    // Credenciales fijas de admin
    const ADMIN_EMAIL = 'admin@mimusicapp.com';
    const ADMIN_PASSWORD = 'admin123';

    // === Funciones de usuario ===
    function saveUser(name, lastname, email, password) {
      let users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      const exists = users.some(u => u.email === email);
      if (!exists) {
        users.push({ name, lastname, email, password });
        localStorage.setItem(usersKey, JSON.stringify(users));
        const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0') + 1;
        localStorage.setItem(USER_COUNT_KEY, userCount.toString());
      }
      localStorage.setItem(currentUserKey, email);
      return { name, lastname, email };
    }

    function login(email, password) {
      // Comprobar si es admin
      if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
        localStorage.setItem(isAdminKey, 'true');
        return { name: 'Administrador', lastname: '', email, admin: true };
      }

      // Comprobar usuarios normales
      const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      const user = users.find(u => u.email === email && u.password === password);
      if (user) {
        localStorage.setItem(currentUserKey, email);
        localStorage.removeItem(isAdminKey);
        return { name: user.name, lastname: user.lastname, email, admin: false };
      }
      return null;
    }

    function logout() {
      localStorage.removeItem(currentUserKey);
      localStorage.removeItem(isAdminKey);
    }

    function isUserAdmin() {
      return localStorage.getItem(isAdminKey) === 'true';
    }

    // === Mostrar estad√≠sticas ===
    function displayStats() {
      const userCountEl = document.getElementById('userCount');
      const downloadCountEl = document.getElementById('downloadCount');
      if (userCountEl && downloadCountEl) {
        const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0');
        const downloadCount = parseInt(localStorage.getItem(DOWNLOAD_COUNT_KEY) || '0');
        userCountEl.textContent = userCount;
        downloadCountEl.textContent = downloadCount;
      }
    }

    // === Panel de administraci√≥n ===
    function renderAdminPanel() {
      const adminUserCount = document.getElementById('adminUserCount');
      const adminDownloadCount = document.getElementById('adminDownloadCount');
      const adminUserList = document.getElementById('adminUserList');

      const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0');
      const downloadCount = parseInt(localStorage.getItem(DOWNLOAD_COUNT_KEY) || '0');
      const users = JSON.parse(localStorage.getItem(usersKey) || '[]');

      adminUserCount.textContent = userCount;
      adminDownloadCount.textContent = downloadCount;

      if (users.length === 0) {
        adminUserList.innerHTML = '<p>No hay usuarios registrados.</p>';
      } else {
        let html = '<ul>';
        users.forEach(u => {
          html += `<li>${u.name} ${u.lastname} ‚Äî ${u.email}</li>`;
        });
        html += '</ul>';
        adminUserList.innerHTML = html;
      }
    }

    // === Manejo de formularios y pantallas ===
    document.addEventListener('DOMContentLoaded', () => {
      displayStats();

      const welcomeScreen = document.getElementById('welcomeScreen');
      const appContainer = document.getElementById('appContainer');
      const adminPanel = document.getElementById('adminPanel');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const userNameDisplay = document.getElementById('userNameDisplay');

      // Botones de navegaci√≥n
      document.getElementById('showLogin')?.addEventListener('click', (e) => {
        e.preventDefault();
        registerForm.style.display = 'none';
        loginForm.style.display = 'block';
      });

      document.getElementById('showRegister')?.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
      });

      // Registro
      document.getElementById('registerBtn')?.addEventListener('click', () => {
        const regName = document.getElementById('regName');
        const regLastname = document.getElementById('regLastname');
        const regEmail = document.getElementById('regEmail');
        const regPassword = document.getElementById('regPassword');
        const regConfirmPassword = document.getElementById('regConfirmPassword');
        const termsCheckbox = document.getElementById('termsCheckbox');
        const privacyCheckbox = document.getElementById('privacyCheckbox');

        const name = regName.value.trim();
        const lastname = regLastname.value.trim();
        const email = regEmail.value.trim();
        const password = regPassword.value;
        const confirmPassword = regConfirmPassword.value;
        const terms = termsCheckbox.checked;
        const privacy = privacyCheckbox.checked;

        if (!name || !lastname || !email || !password || !confirmPassword) {
          alert('Por favor, completa todos los campos.');
          return;
        }
        if (password !== confirmPassword) {
          alert('Las contrase√±as no coinciden.');
          return;
        }
        if (!terms || !privacy) {
          alert('Debes aceptar los t√©rminos y la pol√≠tica de privacidad.');
          return;
        }
        if (!email.includes('@')) {
          alert('Por favor, ingresa un correo v√°lido.');
          return;
        }

        const user = saveUser(name, lastname, email, password);
        userNameDisplay.textContent = `${user.name} ${user.lastname}`;
        welcomeScreen.style.display = 'none';
        appContainer.style.display = 'block';
      });

      // Login
      document.getElementById('loginBtn')?.addEventListener('click', () => {
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const email = loginEmail.value.trim();
        const password = loginPassword.value;
        if (!email || !password) {
          alert('Por favor, completa todos los campos.');
          return;
        }
        const user = login(email, password);
        if (user) {
          if (user.admin) {
            welcomeScreen.style.display = 'none';
            adminPanel.style.display = 'block';
            renderAdminPanel();
          } else {
            userNameDisplay.textContent = `${user.name} ${user.lastname}`;
            welcomeScreen.style.display = 'none';
            appContainer.style.display = 'block';
          }
        } else {
          alert('Correo o contrase√±a incorrectos.');
        }
      });

      // Volver a inicio (alumno)
      document.getElementById('backToWelcome')?.addEventListener('click', () => {
        logout();
        appContainer.style.display = 'none';
        welcomeScreen.style.display = 'flex';
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        // Limpiar
        ['regName','regLastname','regEmail','regPassword','regConfirmPassword','loginEmail','loginPassword'].forEach(id => {
          document.getElementById(id).value = '';
        });
        document.getElementById('termsCheckbox').checked = false;
        document.getElementById('privacyCheckbox').checked = false;
      });

      // Salir del panel de admin
      document.getElementById('backToAdminWelcome')?.addEventListener('click', () => {
        logout();
        adminPanel.style.display = 'none';
        welcomeScreen.style.display = 'flex';
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
      });

      // Restablecer contadores (admin)
      document.getElementById('resetCounters')?.addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro de restablecer los contadores? Esta acci√≥n no se puede deshacer.')) {
          localStorage.setItem(USER_COUNT_KEY, '0');
          localStorage.setItem(DOWNLOAD_COUNT_KEY, '0');
          renderAdminPanel();
          displayStats();
        }
      });

      // Verificar sesi√≥n al cargar
      if (isUserAdmin()) {
        welcomeScreen.style.display = 'none';
        adminPanel.style.display = 'block';
        renderAdminPanel();
      } else {
        const currentUser = JSON.parse(localStorage.getItem(usersKey) || '[]')
          .find(u => u.email === localStorage.getItem(currentUserKey));
        if (currentUser) {
          userNameDisplay.textContent = `${currentUser.name} ${currentUser.lastname}`;
          welcomeScreen.style.display = 'none';
          appPanel.style.display = 'block';
        }
      }
    });
  </script>
</body>
</html>
