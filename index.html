<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Domina tu instrumento</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Pantalla de bienvenida -->
  <div id="welcomeScreen" class="screen">
    <div class="header">
      <div class="logo">
        <div class="icon">üéµ</div>
      </div>
      <div class="waveform"></div>
    </div>
    <div class="content">
      <h1>Domina tu <span>instrumento</span></h1>
      <p>Sincronizaci√≥n de audio y partituras en tiempo real con resaltado inteligente.</p>
      
      <!-- Estad√≠sticas -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="userCount">0</div>
          <div class="stat-label">Usuarios registrados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="downloadCount">0</div>
          <div class="stat-label">Pr√°cticas descargadas</div>
        </div>
      </div>

      <!-- Formulario de registro -->
      <div id="registerForm">
        <h3>Crear cuenta</h3>
        <input type="text" id="regName" placeholder="Nombre" />
        <input type="text" id="regLastname" placeholder="Apellidos" />
        <input type="email" id="regEmail" placeholder="Correo electr√≥nico" />
        <input type="password" id="regPassword" placeholder="Contrase√±a" />
        <input type="password" id="regConfirmPassword" placeholder="Confirmar contrase√±a" />
        
        <div class="terms">
          <label>
            <input type="checkbox" id="termsCheckbox" />
            Acepto los <a href="#" target="_blank">t√©rminos de uso</a>
          </label>
          <label>
            <input type="checkbox" id="privacyCheckbox" />
            He le√≠do la <a href="#" target="_blank">pol√≠tica de protecci√≥n de datos</a>
          </label>
        </div>
        
        <button id="registerBtn" class="btn-primary">Crear cuenta</button>
        <p class="switch-form">¬øYa tienes cuenta? <a id="showLogin">Inicia sesi√≥n</a></p>
      </div>

      <!-- Formulario de login -->
      <div id="loginForm" style="display: none;">
        <h3>Iniciar sesi√≥n</h3>
        <input type="email" id="loginEmail" placeholder="Correo electr√≥nico" />
        <input type="password" id="loginPassword" placeholder="Contrase√±a" />
        <button id="loginBtn" class="btn-primary">Entrar</button>
        <p class="switch-form">¬øEres nuevo? <a id="showRegister">Reg√≠strate</a></p>
      </div>

      <div class="footer-links">
        <p>Tus datos se guardan √∫nicamente en tu dispositivo.</p>
      </div>
    </div>
  </div>

  <!-- App principal -->
  <div id="appContainer" class="screen" style="display: none;">
    <div class="app-header">
      <button id="backToWelcome" class="btn-back">‚Üê Salir</button>
      <h2>üéµ Hola, <span id="userNameDisplay">Usuario</span></h2>
    </div>

    <!-- Audio Upload -->
    <section class="upload-section">
      <label for="audioFile">Sube tu audio (MP3 o MP4):</label>
      <p class="hint">Selecciona la grabaci√≥n de la pieza que vas a practicar.</p>
      <input type="file" id="audioFile" accept="audio/mp3,audio/mpeg,video/mp4" />
      <br />
      <audio id="audioPlayer" controls style="width: 100%; margin-top: 10px;"></audio>
      <br />
      <button id="markFirstNote" disabled>La primera nota entra aqu√≠</button>
      <p class="hint">Reproduce el audio y haz clic en este bot√≥n exactamente cuando suene la primera nota. Esto sincroniza la partitura con el audio.</p>
    </section>

    <!-- Score Upload -->
    <section class="upload-section">
      <label for="scoreFile">Sube la partitura de tu instrumento (PDF, JPG o PNG):</label>
      <p class="hint">Ej: partitura de bater√≠a, tablatura de guitarra, hoja de acordes, etc.</p>
      
      <label for="instrumentSelect">Elige tu instrumento:</label>
      <select id="instrumentSelect" class="instrument-select">
        <option value="">Selecciona tu instrumento</option>
        <option value="bateria">Bater√≠a</option>
        <option value="guitarra">Guitarra</option>
        <option value="bajo">Bajo</option>
        <option value="piano">Piano/Teclado</option>
        <option value="voz">Voz</option>
        <option value="saxo">Saxo</option>
        <option value="trompeta">Trompeta</option>
        <option value="violin">Viol√≠n</option>
        <option value="flauta">Flauta</option>
        <option value="otro">Otro</option>
      </select>

      <input type="file" id="scoreFile" accept=".pdf,.jpg,.jpeg,.png" />
      <div id="scoreContainer" style="margin-top: 10px; text-align: center; min-height: 400px;"></div>
      <p id="instrumentStatus" class="hint" style="margin-top: 10px; font-weight: bold; color: #5e4aff;"></p>
    </section>

    <!-- Resto de controles (BPM, loop, etc.) -->
    <section class="control-section">
      <label for="bpmInput">BPM (beats per minute):</label>
      <p class="hint">Escribe el tempo de la pieza (ej. 120).</p>
      <input type="number" id="bpmInput" min="20" max="300" placeholder="Ej. 120" />
      <button id="startSync">Iniciar sincronizaci√≥n r√≠tmica</button>
      <p id="measureInfo">Duraci√≥n de comp√°s: -- segundos</p>
    </section>

    <section class="control-section">
      <h3>üîÅ Loop por secci√≥n</h3>
      <label>
        Desde comp√°s:
        <input type="number" id="loopFrom" min="1" value="1" />
      </label>
      <label>
        Hasta comp√°s:
        <input type="number" id="loopTo" min="1" value="4" />
      </label>
      <br />
      <button id="setLoop">Establecer loop</button>
      <button id="clearLoop">Limpiar loop</button>
      <p id="loopStatus">Sin loop activo</p>
    </section>

    <button id="exportPractice" class="btn-primary">üíæ Descargar pr√°ctica offline</button>

    <!-- PDF.js -->
    <script src="pdfjs/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
      // === Login/Registro/Admin (tu c√≥digo original) ===
      const usersKey = 'musicApp_users';
      const currentUserKey = 'musicApp_currentUser';
      const USER_COUNT_KEY = 'musicApp_userCount';
      const DOWNLOAD_COUNT_KEY = 'musicApp_downloadCount';
      const isAdminKey = 'musicApp_isAdmin';
      const ADMIN_EMAIL = 'admin@mimusicapp.com';
      const ADMIN_PASSWORD = 'admin123';

      let currentAudioFileName = null;
      let currentOffset = 0;

      // Audio
      const audioFileInput = document.getElementById('audioFile');
      const audioPlayer = document.getElementById('audioPlayer');
      const markFirstNoteBtn = document.getElementById('markFirstNote');

      audioFileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        currentAudioFileName = file.name;
        const url = URL.createObjectURL(file);
        audioPlayer.src = url;
        markFirstNoteBtn.disabled = false;
      });

      // Bot√≥n de sincronizaci√≥n
      markFirstNoteBtn.addEventListener('click', function () {
        if (!currentAudioFileName) return;
        const currentTime = audioPlayer.currentTime;
        currentOffset = -currentTime;
        alert(`Offset establecido: ${currentOffset.toFixed(1)}s`);
      });

      // Partitura
      const scoreFileInput = document.getElementById('scoreFile');
      const scoreContainer = document.getElementById('scoreContainer');
      const instrumentSelect = document.getElementById('instrumentSelect');
      const instrumentStatus = document.getElementById('instrumentStatus');

      instrumentSelect.addEventListener('change', () => {
        const labels = {
          bateria: 'Bater√≠a', guitarra: 'Guitarra', bajo: 'Bajo',
          piano: 'Piano/Teclado', voz: 'Voz', saxo: 'Saxo',
          trompeta: 'Trompeta', violin: 'Viol√≠n', flauta: 'Flauta', otro: 'Otro'
        };
        const instrument = instrumentSelect.value;
        if (instrument) {
          instrumentStatus.textContent = `Practicando: ${labels[instrument]}`;
        } else {
          instrumentStatus.textContent = '';
        }
      });

      scoreFileInput.addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;
        scoreContainer.innerHTML = '<p>Cargando partitura...</p>';
        if (file.type === 'application/pdf') {
          try {
            const url = URL.createObjectURL(file);
            const embed = document.createElement('embed');
            embed.src = url;
            embed.type = 'application/pdf';
            embed.width = '100%';
            embed.height = '500px';
            scoreContainer.innerHTML = '';
            scoreContainer.appendChild(embed);
          } catch (e) {
            scoreContainer.innerHTML = '<p>Error al cargar PDF.</p>';
          }
        } else if (file.type.startsWith('image/')) {
          const url = URL.createObjectURL(file);
          const img = document.createElement('img');
          img.src = url;
          img.style.maxWidth = '100%';
          scoreContainer.innerHTML = '';
          scoreContainer.appendChild(img);
        } else {
          scoreContainer.innerHTML = '<p>Formato no soportado.</p>';
        }
      });

      // Loop (SIN AUTOM√ÅTICO)
      const loopFromInput = document.getElementById('loopFrom');
      const loopToInput = document.getElementById('loopTo');
      const setLoopBtn = document.getElementById('setLoop');
      const clearLoopBtn = document.getElementById('clearLoop');
      const loopStatus = document.getElementById('loopStatus');

      let loopActive = false;
      let loopFrom = 1;
      let loopTo = 4;

      setLoopBtn.addEventListener('click', () => {
        loopFrom = parseInt(loopFromInput.value);
        loopTo = parseInt(loopToInput.value);
        if (isNaN(loopFrom) || isNaN(loopTo) || loopFrom < 1 || loopTo < loopFrom) {
          alert('Rango de compases inv√°lido.');
          return;
        }
        loopActive = true;
        loopStatus.textContent = `Loop activo: compases ${loopFrom} a ${loopTo}`;
        loopStatus.style.color = '#2c7';
      });

      clearLoopBtn.addEventListener('click', () => {
        loopActive = false;
        loopStatus.textContent = 'Sin loop activo';
        loopStatus.style.color = '#888';
      });

      // BPM
      const bpmInput = document.getElementById('bpmInput');
      const startSyncBtn = document.getElementById('startSync');
      const measureInfo = document.getElementById('measureInfo');

      startSyncBtn.addEventListener('click', () => {
        const value = parseFloat(bpmInput.value);
        if (isNaN(value) || value <= 0) {
          alert('Ingresa un BPM v√°lido (ej. 120)');
          return;
        }
        const measureDuration = 60 / value;
        measureInfo.textContent = `Duraci√≥n de comp√°s: ${measureDuration.toFixed(2)} segundos`;
        alert('Sincronizaci√≥n iniciada. Usa los controles de loop si lo necesitas.');
      });

      // Login/Register/Admin (igual que antes)
      function saveUser(name, lastname, email, password) {
        let users = JSON.parse(localStorage.getItem(usersKey) || '[]');
        const exists = users.some(u => u.email === email);
        if (!exists) {
          users.push({ name, lastname, email, password });
          localStorage.setItem(usersKey, JSON.stringify(users));
          const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0') + 1;
          localStorage.setItem(USER_COUNT_KEY, userCount.toString());
        }
        localStorage.setItem(currentUserKey, email);
        return { name, lastname, email };
      }

      function login(email, password) {
        if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
          localStorage.setItem(isAdminKey, 'true');
          return { name: 'Administrador', lastname: '', email, admin: true };
        }
        const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
        const user = users.find(u => u.email === email && u.password === password);
        if (user) {
          localStorage.setItem(currentUserKey, email);
          localStorage.removeItem(isAdminKey);
          return { name: user.name, lastname: user.lastname, email, admin: false };
        }
        return null;
      }

      function displayStats() {
        const userCountEl = document.getElementById('userCount');
        const downloadCountEl = document.getElementById('downloadCount');
        if (userCountEl && downloadCountEl) {
          const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0');
          const downloadCount = parseInt(localStorage.getItem(DOWNLOAD_COUNT_KEY) || '0');
          userCountEl.textContent = userCount;
          downloadCountEl.textContent = downloadCount;
        }
      }

      function restoreSession() {
        const isAdmin = localStorage.getItem(isAdminKey) === 'true';
        const userEmail = localStorage.getItem(currentUserKey);
        const welcomeScreen = document.getElementById('welcomeScreen');
        const appContainer = document.getElementById('appContainer');
        const userNameDisplay = document.getElementById('userNameDisplay');

        if (isAdmin) {
          userNameDisplay.textContent = 'Administrador';
          welcomeScreen.style.display = 'none';
          appContainer.style.display = 'flex';
          setTimeout(() => {
            appContainer.style.display = 'none';
            welcomeScreen.style.display = 'flex';
          }, 100);
        } else if (userEmail) {
          const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
          const user = users.find(u => u.email === userEmail);
          if (user) {
            userNameDisplay.textContent = `${user.name} ${user.lastname}`;
            welcomeScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            return;
          }
        }
        welcomeScreen.style.display = 'flex';
        appContainer.style.display = 'none';
      }

      document.addEventListener('DOMContentLoaded', () => {
        displayStats();
        restoreSession();

        // Login
        document.getElementById('showLogin').addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('registerForm').style.display = 'none';
          document.getElementById('loginForm').style.display = 'block';
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
          const email = document.getElementById('loginEmail').value.trim();
          const password = document.getElementById('loginPassword').value;
          const user = login(email, password);
          if (user) {
            if (user.admin) {
              document.getElementById('userNameDisplay').textContent = 'Administrador';
              document.getElementById('welcomeScreen').style.display = 'none';
              document.getElementById('appContainer').style.display = 'flex';
              setTimeout(() => {
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'flex';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
              }, 100);
            } else {
              document.getElementById('userNameDisplay').textContent = `${user.name} ${user.lastname}`;
              document.getElementById('welcomeScreen').style.display = 'none';
              document.getElementById('appContainer').style.display = 'flex';
            }
          } else {
            alert('Correo o contrase√±a incorrectos.');
          }
        });

        // Registro
        document.getElementById('registerBtn').addEventListener('click', () => {
          const name = document.getElementById('regName').value.trim();
          const lastname = document.getElementById('regLastname').value.trim();
          const email = document.getElementById('regEmail').value.trim();
          const password = document.getElementById('regPassword').value;
          const confirmPassword = document.getElementById('regConfirmPassword').value;
          const terms = document.getElementById('termsCheckbox').checked;
          const privacy = document.getElementById('privacyCheckbox').checked;

          if (!name || !lastname || !email || !password || !confirmPassword) {
            alert('Por favor, completa todos los campos.');
            return;
          }
          if (password !== confirmPassword) {
            alert('Las contrase√±as no coinciden.');
            return;
          }
          if (!terms || !privacy) {
            alert('Debes aceptar los t√©rminos y la pol√≠tica de privacidad.');
            return;
          }
          if (!email.includes('@')) {
            alert('Por favor, ingresa un correo v√°lido.');
            return;
          }

          const user = saveUser(name, lastname, email, password);
          document.getElementById('userNameDisplay').textContent = `${user.name} ${user.lastname}`;
          document.getElementById('welcomeScreen').style.display = 'none';
          document.getElementById('appContainer').style.display = 'flex';
        });

        document.getElementById('showRegister').addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('registerForm').style.display = 'block';
        });

        document.getElementById('backToWelcome').addEventListener('click', () => {
          localStorage.removeItem(currentUserKey);
          localStorage.removeItem(isAdminKey);
          document.getElementById('appContainer').style.display = 'none';
          document.getElementById('welcomeScreen').style.display = 'flex';
        });
      });
    </script>
  </div>
</body>
</html>
