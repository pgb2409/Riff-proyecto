<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Domina tu instrumento</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Pantalla de bienvenida -->
  <div id="welcomeScreen" class="screen">
    <div class="header">
      <div class="logo">
        <div class="icon">üéµ</div>
      </div>
      <div class="waveform"></div>
    </div>
    <div class="content">
      <h1>Domina tu <span>instrumento</span></h1>
      <p>Sincronizaci√≥n de audio y partituras en tiempo real con resaltado inteligente.</p>
      
      <!-- Estad√≠sticas -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="userCount">0</div>
          <div class="stat-label">Usuarios registrados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="downloadCount">0</div>
          <div class="stat-label">Pr√°cticas descargadas</div>
        </div>
      </div>

      <!-- Formulario de registro -->
      <div id="registerForm">
        <h3>Crear cuenta</h3>
        <input type="text" id="regName" placeholder="Nombre" />
        <input type="text" id="regLastname" placeholder="Apellidos" />
        <input type="email" id="regEmail" placeholder="Correo electr√≥nico" />
        <input type="password" id="regPassword" placeholder="Contrase√±a" />
        <input type="password" id="regConfirmPassword" placeholder="Confirmar contrase√±a" />
        
        <div class="terms">
          <label>
            <input type="checkbox" id="termsCheckbox" />
            Acepto los <a href="#" target="_blank">t√©rminos de uso</a>
          </label>
          <label>
            <input type="checkbox" id="privacyCheckbox" />
            He le√≠do la <a href="#" target="_blank">pol√≠tica de protecci√≥n de datos</a>
          </label>
        </div>
        
        <button id="registerBtn" class="btn-primary">Crear cuenta</button>
        <p class="switch-form">¬øYa tienes cuenta? <a id="showLogin">Inicia sesi√≥n</a></p>
      </div>

      <!-- Formulario de login -->
      <div id="loginForm" style="display: none;">
        <h3>Iniciar sesi√≥n</h3>
        <input type="email" id="loginEmail" placeholder="Correo electr√≥nico" />
        <input type="password" id="loginPassword" placeholder="Contrase√±a" />
        <button id="loginBtn" class="btn-primary">Entrar</button>
        <p class="switch-form">¬øEres nuevo? <a id="showRegister">Reg√≠strate</a></p>
      </div>

      <div class="footer-links">
        <p>Tus datos se guardan √∫nicamente en tu dispositivo.</p>
      </div>
    </div>
  </div>

  <!-- App principal -->
  <div id="appContainer" class="screen" style="display: none;">
    <div class="app-header">
      <button id="backToWelcome" class="btn-back">‚Üê Salir</button>
      <h2>üéµ Hola, <span id="userNameDisplay">Usuario</span></h2>
    </div>

    <!-- Paso √∫nico: todo junto -->
    <div class="upload-section">
      <h3>1. Prepara tu pr√°ctica</h3>
      
      <label>Audio (MP3 o MP4):</label>
      <input type="file" id="audioFile" accept="audio/mp3,audio/mpeg,video/mp4" />
      
      <label>Tu instrumento:</label>
      <select id="instrumentSelect" class="instrument-select">
        <option value="">Selecciona tu instrumento</option>
        <option value="bateria">Bater√≠a</option>
        <option value="guitarra">Guitarra</option>
        <option value="bajo">Bajo</option>
        <option value="piano">Piano/Teclado</option>
        <option value="voz">Voz</option>
        <option value="saxo">Saxo</option>
        <option value="trompeta">Trompeta</option>
        <option value="violin">Viol√≠n</option>
        <option value="flauta">Flauta</option>
        <option value="otro">Otro</option>
      </select>
      
      <label>Partitura (PDF, JPG o PNG):</label>
      <input type="file" id="scoreFile" accept=".pdf,.jpg,.jpeg,.png" />
      
      <audio id="audioPlayer" controls style="width: 100%; margin: 15px 0;"></audio>
      <div id="scoreContainer" style="min-height: 300px; margin: 15px 0;"></div>
      
      <button id="startPractice" class="btn-primary" disabled>‚ñ∂Ô∏è Empezar a practicar</button>
      <p class="hint">La app sincronizar√° autom√°ticamente tu audio con la partitura. ¬°No necesitas hacer nada m√°s!</p>
    </div>

    <!-- Vista de pr√°ctica -->
    <div id="practiceView" style="display: none;">
      <div class="control-section">
        <h3>üéõÔ∏è Controles</h3>
        <label>BPM:</label>
        <input type="number" id="bpmInput" value="120" min="20" max="300" />
        <label>Offset (s):</label>
        <input type="number" id="manualOffset" step="0.1" value="0" />
        <button id="applyOffset">Aplicar</button>
        
        <label>Loop:</label>
        <input type="number" id="loopFrom" value="1" min="1" style="width: 45%; margin-right: 5%;" />
        <input type="number" id="loopTo" value="4" min="1" style="width: 45%;" />
        <button id="setLoop">Establecer</button>
        
        <button id="exportPractice">üíæ Descargar pr√°ctica</button>
      </div>
    </div>

    <div id="currentMeasureIndicator" style="display: none;">Comp√°s: <span id="measureNumber">0</span></div>

    <!-- PDF.js -->
    <script src="pdfjs/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
      // === CONFIGURACI√ìN ===
      const ADMIN_EMAIL = 'admin@mimusicapp.com';
      const ADMIN_PASSWORD = 'admin123';
      const usersKey = 'musicApp_users';
      const currentUserKey = 'musicApp_currentUser';
      const USER_COUNT_KEY = 'musicApp_userCount';
      const DOWNLOAD_COUNT_KEY = 'musicApp_downloadCount';
      const isAdminKey = 'musicApp_isAdmin';

      // === ESTADO ===
      let currentAudioFile = null;
      let currentScoreFile = null;
      let currentInstrument = '';
      let currentOffset = 0;
      let bpm = 120;
      let measureDuration = 60 / bpm;
      let loopFrom = 1;
      let loopTo = 4;
      let syncInterval = null;
      let overlayCanvas = null;

      // === ELEMENTOS ===
      const audioFileInput = document.getElementById('audioFile');
      const scoreFileInput = document.getElementById('scoreFile');
      const instrumentSelect = document.getElementById('instrumentSelect');
      const startPracticeBtn = document.getElementById('startPractice');
      const audioPlayer = document.getElementById('audioPlayer');
      const scoreContainer = document.getElementById('scoreContainer');
      const practiceView = document.getElementById('practiceView');

      // === ACTIVAR BOT√ìN ===
      function updateStartButton() {
        const ready = currentAudioFile && currentScoreFile && currentInstrument;
        startPracticeBtn.disabled = !ready;
      }

      // === AUDIO ===
      audioFileInput.addEventListener('change', (e) => {
        currentAudioFile = e.target.files[0];
        if (currentAudioFile) {
          const url = URL.createObjectURL(currentAudioFile);
          audioPlayer.src = url;
        }
        updateStartButton();
      });

      // === PARTITURA ===
      scoreFileInput.addEventListener('change', (e) => {
        currentScoreFile = e.target.files[0];
        if (currentScoreFile) {
          loadScore(currentScoreFile);
        }
        updateStartButton();
      });

      // === INSTRUMENTO ===
      instrumentSelect.addEventListener('change', () => {
        currentInstrument = instrumentSelect.value;
        updateStartButton();
      });

      // === CARGAR PARTITURA ===
      function loadScore(file) {
        scoreContainer.innerHTML = '<p>Cargando...</p>';
        if (file.type === 'application/pdf') {
          try {
            const url = URL.createObjectURL(file);
            const embed = document.createElement('embed');
            embed.src = url;
            embed.type = 'application/pdf';
            embed.width = '100%';
            embed.height = '500px';
            scoreContainer.innerHTML = '';
            scoreContainer.appendChild(embed);
          } catch (e) {
            scoreContainer.innerHTML = '<p style="color:#ff6b6b;">Error PDF</p>';
          }
        } else if (file.type.startsWith('image/')) {
          const url = URL.createObjectURL(file);
          const img = document.createElement('img');
          img.src = url;
          img.style.maxWidth = '100%';
          scoreContainer.innerHTML = '';
          scoreContainer.appendChild(img);
        } else {
          scoreContainer.innerHTML = '<p style="color:#ff6b6b;">Formato no v√°lido</p>';
        }
      }

      // === OVERLAY ===
      function createOverlay() {
        if (overlayCanvas) return;
        const rect = scoreContainer.getBoundingClientRect();
        overlayCanvas = document.createElement('canvas');
        overlayCanvas.width = rect.width;
        overlayCanvas.height = rect.height;
        overlayCanvas.style.position = 'fixed';
        overlayCanvas.style.left = rect.left + 'px';
        overlayCanvas.style.top = rect.top + 'px';
        overlayCanvas.style.pointerEvents = 'none';
        overlayCanvas.style.zIndex = '1000';
        document.body.appendChild(overlayCanvas);
      }

      // === RESALTAR ===
      function highlightMeasure(index) {
        if (!overlayCanvas) return;
        const ctx = overlayCanvas.getContext('2d');
        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        if (index >= 0) {
          const cols = 4;
          const rows = 3;
          const col = index % cols;
          const row = Math.floor(index / cols);
          const w = overlayCanvas.width / cols;
          const h = overlayCanvas.height / rows;
          ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
          ctx.fillRect(col * w, row * h, w, h);
        }
      }

      // === SINCRONIZACI√ìN ===
      function startSync() {
        document.getElementById('currentMeasureIndicator').style.display = 'block';
        measureDuration = 60 / bpm;
        createOverlay();
        
        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(() => {
          const audioTime = audioPlayer.currentTime;
          const syncTime = audioTime + currentOffset;
          const currentMeasure = syncTime >= 0 ? Math.floor(syncTime / measureDuration) : -1;
          document.getElementById('measureNumber').textContent = currentMeasure + 1;
          highlightMeasure(currentMeasure);
          
          // Loop
          if (currentMeasure >= loopTo - 1) {
            const loopStartTime = (loopFrom - 1) * measureDuration;
            audioPlayer.currentTime = loopStartTime - currentOffset;
          }
        }, 100);
      }

      // === EMPEZAR ===
      startPracticeBtn.addEventListener('click', () => {
        document.querySelector('.upload-section').style.display = 'none';
        practiceView.style.display = 'block';
        startSync();
      });

      // === CONTROLES ===
      document.getElementById('applyOffset').addEventListener('click', () => {
        currentOffset = parseFloat(document.getElementById('manualOffset').value) || 0;
      });

      document.getElementById('bpmInput').addEventListener('change', () => {
        bpm = parseInt(document.getElementById('bpmInput').value) || 120;
      });

      document.getElementById('setLoop').addEventListener('click', () => {
        loopFrom = parseInt(document.getElementById('loopFrom').value) || 1;
        loopTo = parseInt(document.getElementById('loopTo').value) || 4;
      });

      // === LOGIN/REGISTRO/ADMIN ===
      // (tu c√≥digo original intacto)
      function saveUser(name, lastname, email, password) {
        let users = JSON.parse(localStorage.getItem(usersKey) || '[]');
        const exists = users.some(u => u.email === email);
        if (!exists) {
          users.push({ name, lastname, email, password });
          localStorage.setItem(usersKey, JSON.stringify(users));
          const userCount = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0') + 1;
          localStorage.setItem(USER_COUNT_KEY, userCount.toString());
        }
        localStorage.setItem(currentUserKey, email);
        return { name, lastname, email };
      }

      function login(email, password) {
        if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
          localStorage.setItem(isAdminKey, 'true');
          return { name: 'Administrador', lastname: '', email, admin: true };
        }
        const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
        const user = users.find(u => u.email === email && u.password === password);
        if (user) {
          localStorage.setItem(currentUserKey, email);
          localStorage.removeItem(isAdminKey);
          return { name: user.name, lastname: user.lastname, email, admin: false };
        }
        return null;
      }

      function displayStats() {
        document.getElementById('userCount').textContent = localStorage.getItem(USER_COUNT_KEY) || '0';
        document.getElementById('downloadCount').textContent = localStorage.getItem(DOWNLOAD_COUNT_KEY) || '0';
      }

      function restoreSession() {
        const isAdmin = localStorage.getItem(isAdminKey) === 'true';
        const userEmail = localStorage.getItem(currentUserKey);
        const welcomeScreen = document.getElementById('welcomeScreen');
        const appContainer = document.getElementById('appContainer');
        const userNameDisplay = document.getElementById('userNameDisplay');

        if (isAdmin) {
          userNameDisplay.textContent = 'Administrador';
          welcomeScreen.style.display = 'none';
          appContainer.style.display = 'flex';
          setTimeout(() => {
            appContainer.style.display = 'none';
            welcomeScreen.style.display = 'flex';
          }, 100);
        } else if (userEmail) {
          const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
          const user = users.find(u => u.email === userEmail);
          if (user) {
            userNameDisplay.textContent = `${user.name} ${user.lastname}`;
            welcomeScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            return;
          }
        }
        welcomeScreen.style.display = 'flex';
        appContainer.style.display = 'none';
      }

      // === INICIALIZACI√ìN ===
      document.addEventListener('DOMContentLoaded', () => {
        displayStats();
        restoreSession();

        // Login
        document.getElementById('showLogin').addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('registerForm').style.display = 'none';
          document.getElementById('loginForm').style.display = 'block';
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
          const email = document.getElementById('loginEmail').value.trim();
          const password = document.getElementById('loginPassword').value;
          const user = login(email, password);
          if (user) {
            if (user.admin) {
              document.getElementById('userNameDisplay').textContent = 'Administrador';
              document.getElementById('welcomeScreen').style.display = 'none';
              document.getElementById('appContainer').style.display = 'flex';
              setTimeout(() => {
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'flex';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
              }, 100);
            } else {
              document.getElementById('userNameDisplay').textContent = `${user.name} ${user.lastname}`;
              document.getElementById('welcomeScreen').style.display = 'none';
              document.getElementById('appContainer').style.display = 'flex';
            }
          } else {
            alert('Correo o contrase√±a incorrectos.');
          }
        });

        // Registro
        document.getElementById('registerBtn').addEventListener('click', () => {
          const name = document.getElementById('regName').value.trim();
          const lastname = document.getElementById('regLastname').value.trim();
          const email = document.getElementById('regEmail').value.trim();
          const password = document.getElementById('regPassword').value;
          const confirmPassword = document.getElementById('regConfirmPassword').value;
          const terms = document.getElementById('termsCheckbox').checked;
          const privacy = document.getElementById('privacyCheckbox').checked;

          if (!name || !lastname || !email || !password || !confirmPassword) {
            alert('Completa todos los campos.');
            return;
          }
          if (password !== confirmPassword) {
            alert('Las contrase√±as no coinciden.');
            return;
          }
          if (!terms || !privacy) {
            alert('Acepta los t√©rminos.');
            return;
          }
          if (!email.includes('@')) {
            alert('Correo v√°lido.');
            return;
          }

          const user = saveUser(name, lastname, email, password);
          document.getElementById('userNameDisplay').textContent = `${user.name} ${user.lastname}`;
          document.getElementById('welcomeScreen').style.display = 'none';
          document.getElementById('appContainer').style.display = 'flex';
        });

        document.getElementById('showRegister').addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('registerForm').style.display = 'block';
        });

        document.getElementById('backToWelcome').addEventListener('click', () => {
          localStorage.removeItem(currentUserKey);
          localStorage.removeItem(isAdminKey);
          document.getElementById('appContainer').style.display = 'none';
          document.getElementById('welcomeScreen').style.display = 'flex';
        });
      });
    </script>
  </div>
</body>
</html>
