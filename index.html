<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Domina tu instrumento</title>
  <style>
    /* --- Dise√±o oscuro profesional restaurado --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f0c1a;
      color: #f0f0f0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #1a132a;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      padding: 25px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #5e4aff;
    }
    .section {
      margin: 25px 0;
      padding: 20px;
      background: #251e35;
      border-radius: 10px;
    }
    .section h2 {
      margin-bottom: 15px;
      color: #5e4aff;
    }
    input[type="file"],
    select,
    input[type="number"],
    button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2c243a;
      color: white;
      font-size: 1rem;
    }
    select {
      background: #2c243a url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding-right: 30px;
    }
    button {
      background: linear-gradient(135deg, #5e4aff 0%, #3b2cff 100%);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(94, 74, 255, 0.4);
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #scoreContainer {
      margin-top: 15px;
      text-align: center;
      min-height: 300px;
      border: 1px dashed #555;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
    }
    #scoreContainer img,
    #scoreContainer canvas {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }
    #currentMeasureIndicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(231, 76, 60, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      background: rgba(94, 74, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .stat-card {
      text-align: center;
    }
    .stat-number {
      font-size: 1.8rem;
      font-weight: bold;
      color: #5e4aff;
    }
    .hint {
      font-size: 0.9rem;
      color: #aaa;
      margin: 10px 0;
      line-height: 1.5;
    }
    .admin-panel {
      background: rgba(243, 156, 18, 0.1);
      border-left: 4px solid #f39c12;
      padding: 15px;
      margin-top: 20px;
    }
    details > summary {
      cursor: pointer;
      color: #5e4aff;
      font-weight: bold;
    }
    @media (max-width: 600px) {
      .container { margin: 10px; padding: 15px; }
      .stats { flex-direction: column; gap: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ Domina tu instrumento</h1>
    
    <!-- Estad√≠sticas -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="userCount">0</div>
        <div>Usuarios</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="downloadCount">0</div>
        <div>Pr√°cticas</div>
      </div>
    </div>

    <!-- Paso √∫nico: todo en uno -->
    <div class="section" id="uploadSection">
      <h2>1. Prepara tu pr√°ctica</h2>
      <p class="hint">Sube tu audio, tu partitura y elige tu instrumento. ¬°La app har√° el resto!</p>
      
      <label>Audio (MP3 o MP4):</label>
      <input type="file" id="audioFile" accept="audio/mp3,audio/mpeg,video/mp4" />
      
      <label>Partitura (PDF, JPG o PNG):</label>
      <input type="file" id="scoreFile" accept=".pdf,.jpg,.jpeg,.png" />
      
      <label>Tu instrumento:</label>
      <select id="instrumentSelect">
        <option value="">Selecciona tu instrumento</option>
        <option value="bateria">Bater√≠a</option>
        <option value="guitarra">Guitarra</option>
        <option value="bajo">Bajo</option>
        <option value="piano">Piano/Teclado</option>
        <option value="voz">Voz</option>
        <option value="saxo">Saxo</option>
        <option value="trompeta">Trompeta</option>
        <option value="violin">Viol√≠n</option>
        <option value="flauta">Flauta</option>
        <option value="otro">Otro</option>
      </select>
      
      <button id="startPractice" disabled>‚ñ∂Ô∏è Empezar a practicar</button>
      <p class="hint">La app sincronizar√° autom√°ticamente la partitura con el audio. ¬°No necesitas hacer nada m√°s!</p>
    </div>

    <!-- Vista de pr√°ctica -->
    <div id="practiceView" style="display: none;">
      <div class="section">
        <h2>2. ¬°Practica!</h2>
        <p class="hint">La partitura se resaltar√° en tiempo real mientras suena el audio.</p>
        <audio id="audioPlayer" controls style="width: 100%; margin: 10px 0; background: #2c243a; padding: 10px; border-radius: 6px;"></audio>
        <div id="scoreContainer">Sube tu partitura para verla aqu√≠</div>
      </div>

      <!-- Controles avanzados (colapsables) -->
      <details class="section">
        <summary>‚öôÔ∏è Ajustes avanzados (solo si es necesario)</summary>
        
        <label>BPM (tempo):</label>
        <input type="number" id="bpmInput" value="120" min="20" max="300" />
        
        <label>Offset (segundos):</label>
        <input type="number" id="manualOffset" step="0.1" value="0" />
        <button id="applyOffset">Aplicar ajuste</button>
        
        <label>Rango de loop:</label>
        <input type="number" id="loopFrom" value="1" min="1" placeholder="Desde" style="width: 48%; margin-right: 4%;" />
        <input type="number" id="loopTo" value="4" min="1" placeholder="Hasta" style="width: 48%;" />
        <button id="setLoop">Establecer loop</button>
        
        <button id="exportPractice">üíæ Descargar pr√°ctica offline</button>
      </details>
    </div>

    <!-- Panel de admin -->
    <div id="adminPanel" class="admin-panel" style="display: none;">
      <h3>üîê Panel de administraci√≥n</h3>
      <button id="resetCounters">Restablecer contadores</button>
      <div id="userList"></div>
    </div>
  </div>

  <!-- Indicador de comp√°s -->
  <div id="currentMeasureIndicator" style="display: none;">
    Comp√°s: <span id="measureNumber">0</span>
  </div>

  <!-- PDF.js -->
  <script src="pdfjs/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdfjs/pdf.worker.min.js';</script>

  <!-- Librer√≠as para ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // === Configuraci√≥n ===
    const ADMIN_EMAIL = 'admin@mimusicapp.com';
    const ADMIN_PASSWORD = 'admin123';
    const usersKey = 'musicApp_users';
    const currentUserKey = 'musicApp_currentUser';
    const isAdminKey = 'musicApp_isAdmin';
    const USER_COUNT_KEY = 'musicApp_userCount';
    const DOWNLOAD_COUNT_KEY = 'musicApp_downloadCount';

    // === Estado ===
    let currentAudioFile = null;
    let currentScoreFile = null;
    let currentInstrument = '';
    let currentOffset = 0;
    let bpm = 120;
    let measureDuration = 60 / bpm;
    let loopFrom = 1;
    let loopTo = 4;
    let syncInterval = null;

    // === Elementos ===
    const audioFileInput = document.getElementById('audioFile');
    const scoreFileInput = document.getElementById('scoreFile');
    const instrumentSelect = document.getElementById('instrumentSelect');
    const startPracticeBtn = document.getElementById('startPractice');
    const audioPlayer = document.getElementById('audioPlayer');
    const scoreContainer = document.getElementById('scoreContainer');
    const practiceView = document.getElementById('practiceView');
    const currentMeasureIndicator = document.getElementById('currentMeasureIndicator');
    const measureNumberEl = document.getElementById('measureNumber');
    const uploadSection = document.getElementById('uploadSection');

    // === Habilitar bot√≥n cuando todo est√© listo ===
    function updateStartButton() {
      const ready = currentAudioFile && currentScoreFile && currentInstrument;
      startPracticeBtn.disabled = !ready;
    }

    audioFileInput.addEventListener('change', (e) => {
      currentAudioFile = e.target.files[0];
      updateStartButton();
    });

    scoreFileInput.addEventListener('change', (e) => {
      currentScoreFile = e.target.files[0];
      updateStartButton();
    });

    instrumentSelect.addEventListener('change', () => {
      currentInstrument = instrumentSelect.value;
      updateStartButton();
    });

    // === Cargar partitura ===
    async function loadScore(file) {
      scoreContainer.innerHTML = '<p>Cargando partitura...</p>';
      if (file.type === 'application/pdf') {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const typedarray = new Uint8Array(arrayBuffer);
          const pdf = await pdfjsLib.getDocument({ typedarray }).promise;
          const page = await pdf.getPage(1);
          const scale = 1.5;
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement('canvas');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          scoreContainer.innerHTML = '';
          scoreContainer.appendChild(canvas);
          const context = canvas.getContext('2d');
          await page.render({ canvasContext: context, viewport }).promise;
        } catch (e) {
          console.error('Error PDF:', e);
          scoreContainer.innerHTML = '<p style="color:#ff6b6b;">‚ö†Ô∏è No se pudo cargar el PDF. Prueba con una imagen.</p>';
        }
      } else if (file.type.startsWith('image/')) {
        const url = URL.createObjectURL(file);
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = '100%';
        scoreContainer.innerHTML = '';
        scoreContainer.appendChild(img);
      } else {
        scoreContainer.innerHTML = '<p style="color:#ff6b6b;">‚ö†Ô∏è Formato no soportado.</p>';
      }
    }

    // === Sincronizaci√≥n autom√°tica (CORREGIDA) ===
    function startSync() {
      currentMeasureIndicator.style.display = 'block';
      measureDuration = 60 / bpm;
      
      if (syncInterval) clearInterval(syncInterval);
      syncInterval = setInterval(() => {
        const audioTime = audioPlayer.currentTime;
        const syncTime = audioTime + currentOffset;
        const currentMeasure = syncTime >= 0 ? Math.floor(syncTime / measureDuration) + 1 : 0;
        measureNumberEl.textContent = currentMeasure;
        
        // ‚úÖ CORRECCI√ìN: solo hacer loop si est√° activado (from < to)
        if (loopFrom < loopTo && currentMeasure > loopTo) {
          const loopStartTime = (loopFrom - 1) * measureDuration;
          audioPlayer.currentTime = loopStartTime - currentOffset;
        }
      }, 100);
    }

    // === Iniciar pr√°ctica ===
    startPracticeBtn.addEventListener('click', async () => {
      const audioUrl = URL.createObjectURL(currentAudioFile);
      audioPlayer.src = audioUrl;
      await loadScore(currentScoreFile);
      
      uploadSection.style.display = 'none';
      practiceView.style.display = 'block';
      
      startSync();
    });

    // === Controles avanzados ===
    document.getElementById('applyOffset').addEventListener('click', () => {
      currentOffset = parseFloat(document.getElementById('manualOffset').value) || 0;
    });

    document.getElementById('bpmInput').addEventListener('change', () => {
      bpm = parseInt(document.getElementById('bpmInput').value) || 120;
      measureDuration = 60 / bpm;
    });

    document.getElementById('setLoop').addEventListener('click', () => {
      loopFrom = parseInt(document.getElementById('loopFrom').value) || 1;
      loopTo = parseInt(document.getElementById('loopTo').value) || 4;
    });

    // === Contadores y admin ===
    function displayStats() {
      document.getElementById('userCount').textContent = localStorage.getItem(USER_COUNT_KEY) || '0';
      document.getElementById('downloadCount').textContent = localStorage.getItem(DOWNLOAD_COUNT_KEY) || '0';
    }

    function saveUser(name, lastname, email, password) {
      let users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      if (!users.some(u => u.email === email)) {
        users.push({ name, lastname, email, password });
        localStorage.setItem(usersKey, JSON.stringify(users));
        const count = parseInt(localStorage.getItem(USER_COUNT_KEY) || '0') + 1;
        localStorage.setItem(USER_COUNT_KEY, count.toString());
      }
      localStorage.setItem(currentUserKey, email);
    }

    function login(email, password) {
      if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
        localStorage.setItem(isAdminKey, 'true');
        return true;
      }
      const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      const user = users.find(u => u.email === email && u.password === password);
      if (user) {
        localStorage.setItem(currentUserKey, email);
        return true;
      }
      return false;
    }

    function isAdmin() {
      return localStorage.getItem(isAdminKey) === 'true';
    }

    // === Inicializaci√≥n ===
    displayStats();

    // Panel de admin
    if (isAdmin()) {
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('resetCounters').addEventListener('click', () => {
        if (confirm('¬øRestablecer contadores?')) {
          localStorage.setItem(USER_COUNT_KEY, '0');
          localStorage.setItem(DOWNLOAD_COUNT_KEY, '0');
          displayStats();
        }
      });
      
      const users = JSON.parse(localStorage.getItem(usersKey) || '[]');
      document.getElementById('userList').innerHTML = `
        <h4>Usuarios registrados (${users.length}):</h4>
        <ul>${users.map(u => `<li>${u.name} ${u.lastname} ‚Äî ${u.email}</li>`).join('')}</ul>
      `;
    }
  </script>
</body>
</html>
